# æ™ºèƒ½è‡ªé€‚åº”é¢˜åº“ç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆ

**åŸºäºå¼ºåŒ–å­¦ä¹ ä¸è®°å¿†æ›²çº¿çš„ä¸ªæ€§åŒ–å­¦ä¹ å¹³å°**

---

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°ä¸é—®é¢˜å®šä¹‰](#1-ç³»ç»Ÿæ¦‚è¿°ä¸é—®é¢˜å®šä¹‰)
2. [æŠ€æœ¯æ¶æ„ä¸æ¨¡å—è®¾è®¡](#2-æŠ€æœ¯æ¶æ„ä¸æ¨¡å—è®¾è®¡)
3. [å¼ºåŒ–å­¦ä¹ é€‰é¢˜æœºåˆ¶](#3-å¼ºåŒ–å­¦ä¹ é€‰é¢˜æœºåˆ¶)
4. [æ™ºèƒ½å¤ä¹ è°ƒåº¦ç³»ç»Ÿ](#4-æ™ºèƒ½å¤ä¹ è°ƒåº¦ç³»ç»Ÿ)
5. [å‘é‡æ£€ç´¢ä¸ç›¸ä¼¼åº¦æ§åˆ¶](#5-å‘é‡æ£€ç´¢ä¸ç›¸ä¼¼åº¦æ§åˆ¶)
6. [èƒ½åŠ›è¯„ä¼°ä¸åŠ¨æ€è¿½è¸ª](#6-èƒ½åŠ›è¯„ä¼°ä¸åŠ¨æ€è¿½è¸ª)
7. [ç”¨æˆ·äº¤äº’ä¸æ•°æ®å¯è§†åŒ–](#7-ç”¨æˆ·äº¤äº’ä¸æ•°æ®å¯è§†åŒ–)
8. [æ€§èƒ½ä¼˜åŒ–ä¸å·¥ç¨‹å®è·µ](#8-æ€§èƒ½ä¼˜åŒ–ä¸å·¥ç¨‹å®è·µ)
9. [æ€»ç»“ä¸å±•æœ›](#9-æ€»ç»“ä¸å±•æœ›)

---

## 1. ç³»ç»Ÿæ¦‚è¿°ä¸é—®é¢˜å®šä¹‰

### 1.1 ç ”ç©¶èƒŒæ™¯

ä¼ ç»Ÿé¢˜åº“ç³»ç»Ÿåœ¨ç”µç½‘çŸ¥è¯†åŸ¹è®­åœºæ™¯ä¸­é¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼š

**å­¦ä¹ æ•ˆç‡ç“¶é¢ˆ**
- é¢˜ç›®æ¨èç¼ºä¹ä¸ªæ€§åŒ–ï¼Œ"ä¸€åˆ€åˆ‡"æ¨¡å¼å¯¼è‡´èƒ½åŠ›å¼ºçš„ç”¨æˆ·é‡å¤åˆ·ç®€å•é¢˜ï¼Œèƒ½åŠ›å¼±çš„ç”¨æˆ·é¢å¯¹è¿‡éš¾é¢˜ç›®æŒ«è´¥æ„Ÿå¼º
- æ— æ³•æ ¹æ®ç”¨æˆ·å®æ—¶è¡¨ç°åŠ¨æ€è°ƒæ•´é¢˜ç›®éš¾åº¦å’Œç±»å‹
- ç¼ºä¹å¯¹å­¦ä¹ è¿›ç¨‹çš„é•¿æœŸä¼˜åŒ–ï¼Œä»…å…³æ³¨å•æ¬¡ç­”é¢˜è€Œéæ•´ä½“å­¦ä¹ è·¯å¾„

**å¤ä¹ æœºåˆ¶ç¼ºé™·**
- å›ºå®šé—´éš”å¤ä¹ ç­–ç•¥æ— æ³•é€‚åº”ä¸åŒç”¨æˆ·çš„è®°å¿†æ›²çº¿å·®å¼‚
- ç¼ºå°‘å¯¹é—å¿˜è§„å¾‹çš„ç§‘å­¦å»ºæ¨¡ï¼Œå¤ä¹ æ—¶æœºä¸å¤Ÿç²¾å‡†
- æ— æ³•åŒºåˆ†ä¸åŒéš¾åº¦å’Œé‡è¦æ€§é¢˜ç›®çš„å¤ä¹ ä¼˜å…ˆçº§

**é¢˜ç›®åŒè´¨åŒ–é—®é¢˜**
- è¯­ä¹‰ç›¸ä¼¼é¢˜ç›®é¢‘ç¹å‡ºç°ï¼Œå¯¼è‡´ç”¨æˆ·äº§ç”Ÿ"åˆ·é¢˜ç–²åŠ³"
- ç¼ºå°‘å¯¹é¢˜ç›®å†…å®¹çš„æ·±å±‚ç†è§£ï¼Œä»…ä¾èµ–éšæœºæŠ½æ ·æˆ–ç®€å•è§„åˆ™
- ç”¨æˆ·å·²æŒæ¡çš„çŸ¥è¯†ç‚¹å¯¹åº”é¢˜ç›®ä»é«˜é¢‘å‡ºç°ï¼Œæµªè´¹å­¦ä¹ æ—¶é—´

### 1.2 ç³»ç»Ÿç›®æ ‡

æœ¬ç³»ç»Ÿæ—¨åœ¨æ„å»ºä¸€ä¸ª**åŸºäºå¼ºåŒ–å­¦ä¹ ä¸è®¤çŸ¥ç§‘å­¦**çš„æ™ºèƒ½è‡ªé€‚åº”é¢˜åº“å¹³å°ï¼Œå®ç°ä»¥ä¸‹æ ¸å¿ƒç›®æ ‡ï¼š

1. **æœ€ä¼˜åŒ–å­¦ä¹ è·¯å¾„**ï¼šé€šè¿‡å¼ºåŒ–å­¦ä¹ è‡ªåŠ¨æ¢ç´¢æœ€ä½³å‡ºé¢˜ç­–ç•¥ï¼Œæœ€å¤§åŒ–é•¿æœŸå­¦ä¹ æ”¶ç›Š
2. **ç§‘å­¦åŒ–å¤ä¹ è°ƒåº¦**ï¼šåŸºäºSuperMemo-2ç®—æ³•å®ç°ç²¾å‡†çš„ä¸ªæ€§åŒ–å¤ä¹ é—´éš”
3. **æ™ºèƒ½åŒ–é¢˜ç›®å»é‡**ï¼šåˆ©ç”¨æ·±åº¦è¯­ä¹‰ç†è§£é¿å…é«˜ç›¸ä¼¼åº¦é¢˜ç›®é‡å¤å‡ºç°
4. **åŠ¨æ€åŒ–èƒ½åŠ›è¿½è¸ª**ï¼šé‡‡ç”¨è´å¶æ–¯æ–¹æ³•å®æ—¶æ›´æ–°ç”¨æˆ·èƒ½åŠ›ä¼°è®¡åŠç½®ä¿¡åº¦

### 1.3 æŠ€æœ¯åˆ›æ–°ç‚¹

| åˆ›æ–°ç‚¹ | ä¼ ç»Ÿæ–¹æ³• | æœ¬ç³»ç»Ÿæ–¹æ¡ˆ | ä¼˜åŠ¿ |
|--------|----------|------------|------|
| **é¢˜ç›®é€‰æ‹©** | éšæœºæŠ½æ ·/è§„åˆ™æ‰“åˆ† | Q-Learningå¼ºåŒ–å­¦ä¹  | è‡ªåŠ¨ä¼˜åŒ–é•¿æœŸæ”¶ç›Š |
| **æ¢ç´¢-åˆ©ç”¨å¹³è¡¡** | å›ºå®šæ¦‚ç‡æ¢ç´¢ | UCBç½®ä¿¡ä¸Šç•Œç®—æ³• | ç†è®ºæœ€ä¼˜ä¿è¯ |
| **å¤ä¹ è°ƒåº¦** | Leitnerå›ºå®šåˆ†æ¡¶ | SM-2åŠ¨æ€é—´éš” | ç²¾ç»†åŒ–ä¸ªæ€§é—´éš” |
| **èƒ½åŠ›æ›´æ–°** | å›ºå®šæ­¥é•¿(Â±0.15) | è´å¶æ–¯åéªŒæ›´æ–° | è‡ªé€‚åº”æ­¥é•¿+ä¸ç¡®å®šæ€§é‡åŒ– |
| **é¢˜ç›®å»é‡** | IDå»é‡ | æ·±åº¦è¯­ä¹‰å‘é‡ | è¯­ä¹‰çº§ç›¸ä¼¼åº¦æ§åˆ¶ |

---

## 2. æŠ€æœ¯æ¶æ„ä¸æ¨¡å—è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·äº¤äº’å±‚ (Streamlit)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ é¢˜ç›®ç­›é€‰é¢æ¿ â”‚  â”‚  ç­”é¢˜ç•Œé¢    â”‚  â”‚ å­¦ä¹ è®°å½•ç»Ÿè®¡ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚ (adaptive/)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Scorer    â”‚  â”‚  Selector   â”‚  â”‚  Scheduler  â”‚         â”‚
â”‚  â”‚ Q-Learning  â”‚â†’ â”‚     UCB     â”‚  â”‚    SM-2     â”‚         â”‚
â”‚  â”‚   æ‰“åˆ†å™¨    â”‚  â”‚   é€‰æ‹©å™¨    â”‚  â”‚  å¤ä¹ è°ƒåº¦   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â†“                  â†“                â†“                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚     BayesianAbilityTracker (èƒ½åŠ›è¿½è¸ª)         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ JSONLé¢˜åº“    â”‚  â”‚ Qdrantå‘é‡åº“ â”‚  â”‚ å†å²å­¦ä¹ è®°å½• â”‚      â”‚
â”‚  â”‚ (æœ¬åœ°æ–‡ä»¶)   â”‚  â”‚ (è¯­ä¹‰æ£€ç´¢)   â”‚  â”‚  (rounds/)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 2.2.1 Scorer (Q-Learningæ‰“åˆ†å™¨)

**æ–‡ä»¶ä½ç½®**: `adaptive/scorer.py`

**åŠŸèƒ½**: ä½¿ç”¨å¼ºåŒ–å­¦ä¹ Qå€¼ä¼°è®¡é¢˜ç›®ä»·å€¼ï¼Œæ›¿ä»£ä¼ ç»Ÿçº¿æ€§æ‰“åˆ†

**æ ¸å¿ƒæ€æƒ³**:
- æ¯é“é¢˜ç»´æŠ¤ä¸€ä¸ªQå€¼ï¼Œè¡¨ç¤º"é€‰æ‹©è¯¥é¢˜çš„æœŸæœ›ç´¯ç§¯å›æŠ¥"
- ä»å†å²å­¦ä¹ è®°å½•åˆå§‹åŒ–Qå€¼
- åœ¨çº¿å­¦ä¹ åŠ¨æ€æ›´æ–°Qå€¼è¡¨

**ä»£ç å®ç°** (`scorer.py`, line 14-155):

```python
class Scorer:
    """Q-Learningæ‰“åˆ†å™¨"""
    
    def __init__(self, params):
        self.alpha = 0.1    # å­¦ä¹ ç‡
        self.gamma = 0.9    # æŠ˜æ‰£å› å­
        self.epsilon = 0.1  # æ¢ç´¢ç‡
        self.q_values: Dict[str, float] = {}
```

#### 2.2.2 Selector (UCBé€‰æ‹©å™¨)

**æ–‡ä»¶ä½ç½®**: `adaptive/selector.py`

**åŠŸèƒ½**: ä½¿ç”¨UCBç®—æ³•åœ¨æ¢ç´¢ä¸åˆ©ç”¨ä¹‹é—´å–å¾—ç†è®ºæœ€ä¼˜å¹³è¡¡

**æ ¸å¿ƒæ€æƒ³**:
- è®¡ç®—æ¯é“é¢˜çš„ç½®ä¿¡ä¸Šç•Œ: UCB = Qå€¼ + æ¢ç´¢å¥–åŠ±
- é€‰æ‹©UCBæœ€é«˜çš„é¢˜ç›®
- è‡ªåŠ¨å¢åŠ å¯¹æœªå……åˆ†æ¢ç´¢é¢˜ç›®çš„é€‰æ‹©é¢‘ç‡

**ä»£ç å®ç°** (`selector.py`, line 14-102):

```python
class Selector:
    """UCBé€‰æ‹©å™¨"""
    
    def __init__(self, scorer: Scorer, temp: float):
        self.scorer = scorer
        self.ucb_c = math.sqrt(2)  # UCBæ¢ç´¢ç³»æ•°
```

#### 2.2.3 Scheduler (SM-2å¤ä¹ è°ƒåº¦å™¨)

**æ–‡ä»¶ä½ç½®**: `adaptive/scheduler.py`

**åŠŸèƒ½**: å®ç°SuperMemo-2ç®—æ³•ï¼Œæä¾›ç²¾ç»†åŒ–ä¸ªæ€§åŒ–å¤ä¹ é—´éš”

**æ ¸å¿ƒæ€æƒ³**:
- ç»´æŠ¤æ˜“åº¦å› å­(EF)è¡¨ç¤ºé¢˜ç›®å¯¹ç”¨æˆ·çš„éš¾æ˜“ç¨‹åº¦
- æ ¹æ®ç­”é¢˜è´¨é‡åŠ¨æ€è°ƒæ•´å¤ä¹ é—´éš”
- è¿ç»­ç­”å¯¹åˆ™é—´éš”æŒ‡æ•°å¢é•¿ï¼Œç­”é”™åˆ™é‡ç½®

**ä»£ç å®ç°** (`scheduler.py`, line 12-84):

```python
class Scheduler:
    """SM-2ç®—æ³•å®ç°"""
    
    def __init__(self, intervals_days: Tuple[int, ...]):
        self.min_ef = 1.3  # æ˜“åº¦å› å­æœ€å°å€¼
```

#### 2.2.4 BayesianAbilityTracker (è´å¶æ–¯èƒ½åŠ›è¿½è¸ªå™¨)

**æ–‡ä»¶ä½ç½®**: `adaptive/ability.py`

**åŠŸèƒ½**: ä½¿ç”¨è´å¶æ–¯æ–¹æ³•åŠ¨æ€æ›´æ–°ç”¨æˆ·èƒ½åŠ›å€¼åŠä¸ç¡®å®šæ€§

**æ ¸å¿ƒæ€æƒ³**:
- èƒ½åŠ›å€¼è¡¨ç¤ºä¸ºæ­£æ€åˆ†å¸ƒ N(Î¼, ÏƒÂ²)
- æ ¹æ®ç­”é¢˜ç»“æœè¿›è¡Œè´å¶æ–¯åéªŒæ›´æ–°
- è‡ªé€‚åº”å­¦ä¹ ç‡ï¼ŒåˆæœŸå¿«é€Ÿè°ƒæ•´ï¼ŒåæœŸç»†å¾®ä¿®æ­£

**ä»£ç å®ç°** (`ability.py`, line 11-101):

```python
class BayesianAbilityTracker:
    """è´å¶æ–¯èƒ½åŠ›è¿½è¸ªå™¨"""
    
    def __init__(self, initial_ability: float = 1.0, 
                 initial_variance: float = 1.0):
        self.ability = initial_ability
        self.variance = initial_variance
```

### 2.3 æ•°æ®æ¨¡å‹

**æ–‡ä»¶ä½ç½®**: `adaptive/models.py`

ç³»ç»Ÿå®šä¹‰äº†æ¸…æ™°çš„æ•°æ®æ¨¡å‹ä»¥æ”¯æŒå„æ¨¡å—åä½œï¼š

```python
@dataclass
class ItemMeta:
    """é¢˜ç›®å…ƒæ•°æ®"""
    id: str
    difficulty_num: int  # æ•°å€¼åŒ–éš¾åº¦ [1-5]
    field: Optional[str]
    type: Optional[str]
    knowledge_points: List[str]

@dataclass
class ReviewEntry:
    """SM-2å¤ä¹ æ¡ç›®"""
    easiness_factor: float    # æ˜“åº¦å› å­ EF [1.3, âˆ)
    interval_days: float      # å½“å‰é—´éš”(å¤©)
    repetitions: int          # è¿ç»­ç­”å¯¹æ¬¡æ•°
    next_ts_ms: int          # ä¸‹æ¬¡å¤ä¹ æ—¶é—´æˆ³

@dataclass
class SessionState:
    """ä¼šè¯çŠ¶æ€"""
    ability: float                          # èƒ½åŠ›å‡å€¼
    ability_variance: float                 # èƒ½åŠ›æ–¹å·®
    answers_by_item: Dict[str, AnswerRecord]
    review_schedule: Dict[str, ReviewEntry]
    q_values: Dict[str, float]              # Qå€¼è¡¨
    item_selection_counts: Dict[str, int]   # é€‰æ‹©è®¡æ•°(UCB)
    total_selections: int                   # æ€»é€‰æ‹©æ¬¡æ•°
```

**ä»£ç ä½ç½®**: `models.py`, line 13-70

---

## 3. å¼ºåŒ–å­¦ä¹ é€‰é¢˜æœºåˆ¶

### 3.1 é—®é¢˜å»ºæ¨¡

å°†é¢˜ç›®é€‰æ‹©é—®é¢˜å»ºæ¨¡ä¸º**å¤šè‡‚è€è™æœº(Multi-Armed Bandit, MAB)**é—®é¢˜ï¼š

- **çŠ¶æ€(State)**: ç”¨æˆ·å½“å‰èƒ½åŠ›å€¼ã€å·²ç­”é¢˜ç›®å†å²ã€å¤ä¹ è°ƒåº¦çŠ¶æ€
- **åŠ¨ä½œ(Action)**: é€‰æ‹©æŸé“é¢˜ç›®æ¨èç»™ç”¨æˆ·
- **å¥–åŠ±(Reward)**: 
  - ç­”å¯¹: +1
  - ç­”é”™: -0.5
  - å¤ä¹ åˆ°æœŸé¢˜ç›®: +é¢å¤–å¥–åŠ±
- **ç›®æ ‡**: æœ€å¤§åŒ–ç´¯ç§¯å¥–åŠ± = æœ€å¤§åŒ–å­¦ä¹ æ•ˆæœ

### 3.2 Q-Learningç®—æ³•å®ç°

#### 3.2.1 Bellmanæ›´æ–°æ–¹ç¨‹

Qå€¼æ›´æ–°éµå¾ªç»å…¸Q-Learningçš„Bellmanæ–¹ç¨‹ï¼š

$$
Q(s, a) \leftarrow Q(s, a) + \alpha \left[ r + \gamma \max_{a'} Q(s', a') - Q(s, a) \right]
$$

å…¶ä¸­ï¼š
- $\alpha$ : å­¦ä¹ ç‡ (0.1)
- $\gamma$ : æŠ˜æ‰£å› å­ (0.9)
- $r$ : å³æ—¶å¥–åŠ±
- $\max_{a'} Q(s', a')$ : ä¸‹ä¸€çŠ¶æ€çš„æœ€å¤§Qå€¼

**ä»£ç å®ç°** (`scorer.py`, line 132-154):

```python
def update_q_value(self, item_id: str, reward: float, 
                   next_max_q: float = 0.0) -> None:
    """Qå€¼åœ¨çº¿æ›´æ–°
    
    Q(s,a) â† Q(s,a) + Î±[r + Î³Â·max Q(s',a') - Q(s,a)]
    """
    current_q = self.q_values.get(item_id, 0.0)
    
    # Bellmanæ›´æ–°
    td_target = reward + self.gamma * next_max_q
    td_error = td_target - current_q
    new_q = current_q + self.alpha * td_error
    
    self.q_values[item_id] = new_q
```

#### 3.2.2 Qå€¼åˆå§‹åŒ–ç­–ç•¥

ç³»ç»Ÿä»å†å²å­¦ä¹ è®°å½•ä¸­æå–é¢˜ç›®è¡¨ç°ï¼Œåˆå§‹åŒ–Qå€¼è¡¨ï¼š

$$
Q_{\text{init}}(item) = \frac{\text{correct\_count}}{\text{total\_count}} \times 5.0 - 2.0
$$

**ä»£ç å®ç°** (`scorer.py`, line 29-56):

```python
def initialize_from_history(self, history_data: List[Dict]) -> None:
    """ä»æœ€è¿‘15æ¡roundsè®°å½•åˆå§‹åŒ–Qå€¼"""
    item_stats: Dict[str, List[bool]] = {}
    
    for round_data in history_data:
        items = round_data.get("items", [])
        for item_data in items:
            item_id = item_data.get("id", "")
            is_correct = item_data.get("is_correct")
            
            if item_id and is_correct is not None:
                if item_id not in item_stats:
                    item_stats[item_id] = []
                item_stats[item_id].append(is_correct)
    
    # è®¡ç®—åˆå§‹Qå€¼
    for item_id, results in item_stats.items():
        accuracy = sum(results) / len(results)
        self.q_values[item_id] = accuracy * 5.0 - 2.0
```

**è®¾è®¡äº®ç‚¹**:
- å½’ä¸€åŒ–åˆ°[-2, 3]åŒºé—´ï¼Œä¸å…¶ä»–æ‰“åˆ†é¡¹é‡çº§ä¸€è‡´
- é«˜æ­£ç¡®ç‡é¢˜ç›®è·å¾—æ­£Qå€¼ï¼ˆé¼“åŠ±å·©å›ºï¼‰
- ä½æ­£ç¡®ç‡é¢˜ç›®è·å¾—è´ŸQå€¼ï¼ˆéœ€è¦åŠ å¼ºï¼‰

#### 3.2.3 ç»¼åˆæ‰“åˆ†å‡½æ•°

Q-Learningæ‰“åˆ†å™¨æ•´åˆå¤šä¸ªç»´åº¦è®¡ç®—æœ€ç»ˆåˆ†æ•°ï¼š

$$
\text{Score}(item) = Q_{\text{base}}(item) + R_{\text{difficulty}} + B_{\text{review}} + E_{\text{explore}} + V_{\text{knowledge}} - P_{\text{similarity}} + W_{\text{wrong}}
$$

å„é¡¹è¯¦ç»†å®šä¹‰ï¼š

**1. éš¾åº¦é€‚é…å¥–åŠ±**

$$
R_{\text{difficulty}} = -|d_{item} - a_{user}| \times 0.5
$$

- $d_{item}$ : é¢˜ç›®éš¾åº¦ [1-5]
- $a_{user}$ : ç”¨æˆ·èƒ½åŠ›å€¼
- å«ä¹‰ï¼šé¢˜ç›®éš¾åº¦ä¸ç”¨æˆ·èƒ½åŠ›è¶Šæ¥è¿‘ï¼Œåˆ†æ•°è¶Šé«˜

**2. å¤ä¹ ä¼˜å…ˆåŠ æˆ**

$$
B_{\text{review}} = 
\begin{cases}
3.0 + \min(2.0, \Delta_{days}) & \text{if åˆ°æœŸæˆ–é€¾æœŸ} \\
0 & \text{otherwise}
\end{cases}
$$

å…¶ä¸­ $\Delta_{days} = \frac{t_{now} - t_{next}}{86400000}$ (é€¾æœŸå¤©æ•°)

**3. æ¢ç´¢å¥–åŠ± (UCBæ€æƒ³)**

$$
E_{\text{explore}} = 
\begin{cases}
\sqrt{\frac{2 \ln N}{n_i}} & \text{if } n_i > 0 \\
2.0 & \text{if } n_i = 0 \text{ (æ–°é¢˜)}
\end{cases}
$$

- $N$ : æ€»é€‰æ‹©æ¬¡æ•°
- $n_i$ : é¢˜ç›®içš„é€‰æ‹©æ¬¡æ•°

**4. çŸ¥è¯†ç‚¹ä»·å€¼**

$$
V_{\text{knowledge}} = |\{kp : kp \in \text{item.kps} \land \text{mastery}(kp) < d_{item}\}| \times 0.3
$$

æœªæŒæ¡çš„çŸ¥è¯†ç‚¹è¶Šå¤šï¼Œä»·å€¼è¶Šé«˜

**5. ç›¸ä¼¼é¢˜æŠ‘åˆ¶æƒ©ç½š** (è¯¦è§5.3èŠ‚)

**6. é”™é¢˜å¢å¼ºå¥–åŠ±** (è¯¦è§5.4èŠ‚)

**ä»£ç å®ç°** (`scorer.py`, line 58-130):

```python
def score(self, item: ItemMeta, state: SessionState,
          recent_correct_complex_ids: List[str],
          get_neighbors_fn: Callable, 
          get_complex_difficulty_fn: Callable) -> float:
    """Q-Learningæ‰“åˆ†"""
    
    # 1. åŸºç¡€Qå€¼
    base_q = self.q_values.get(item.id, 0.0)
    
    # 2. éš¾åº¦é€‚é…å¥–åŠ±
    difficulty_reward = -abs(item.difficulty_num - state.ability) * 0.5
    
    # 3. å¤ä¹ ä¼˜å…ˆåŠ æˆ
    review_bonus = 0.0
    entry = state.review_schedule.get(item.id)
    if entry:
        now = int(time.time() * 1000)
        next_ts = entry.next_ts_ms
        if now >= next_ts:
            overdue_days = (now - next_ts) / 86400000.0
            review_bonus = 3.0 + min(2.0, overdue_days)
    
    # 4. æ¢ç´¢å¥–åŠ±ï¼ˆUCBï¼‰
    selection_count = state.item_selection_counts.get(item.id, 0)
    if state.total_selections > 0 and selection_count > 0:
        exploration_bonus = math.sqrt(
            2 * math.log(state.total_selections) / selection_count
        )
    else:
        exploration_bonus = 2.0  # æ–°é¢˜ç›®
    
    # 5. çŸ¥è¯†ç‚¹ä»·å€¼
    knowledge_value = 0.0
    if item.knowledge_points:
        uncovered = [
            kp for kp in item.knowledge_points 
            if state.kp_mastery.get(kp, 0) < item.difficulty_num
        ]
        if uncovered:
            knowledge_value = len(uncovered) * 0.3
    
    # 6. ç›¸ä¼¼é¢˜æŠ‘åˆ¶
    similarity_penalty = self._similar_suppression(...)
    
    # 7. é”™é¢˜å¢å¼º
    wrong_boost = self._wrong_boost(...)
    
    # Q-Learningæ€»åˆ†
    total_score = (
        base_q + 
        difficulty_reward + 
        review_bonus + 
        exploration_bonus * 0.5 + 
        knowledge_value - 
        similarity_penalty * 0.3 + 
        wrong_boost * 0.5
    )
    
    return total_score
```

### 3.3 UCBé€‰æ‹©ç­–ç•¥

#### 3.3.1 UCBç®—æ³•åŸç†

UCB (Upper Confidence Bound) æä¾›äº†æ¢ç´¢-åˆ©ç”¨æƒè¡¡çš„**ç†è®ºæœ€ä¼˜è§£**ï¼š

$$
\text{UCB}(item) = Q(item) + c \sqrt{\frac{\ln N}{n_{item}}}
$$

å…¶ä¸­ï¼š
- $Q(item)$ : é¢˜ç›®çš„Qå€¼ï¼ˆåˆ©ç”¨é¡¹ï¼‰
- $c \sqrt{\frac{\ln N}{n_{item}}}$ : ç½®ä¿¡ä¸Šç•Œï¼ˆæ¢ç´¢é¡¹ï¼‰
- $c = \sqrt{2}$ : æ¢ç´¢ç³»æ•°
- $N$ : æ€»é€‰æ‹©æ¬¡æ•°
- $n_{item}$ : è¯¥é¢˜è¢«é€‰æ¬¡æ•°

**ç†è®ºä¿è¯**: UCBç®—æ³•çš„é—æ†¾ä¸Šç•Œ(Regret)ä¸º $O(\sqrt{n \ln n})$ï¼Œåœ¨MABé—®é¢˜ä¸­è¾¾åˆ°ç†è®ºæœ€ä¼˜

#### 3.3.2 å®ç°ç»†èŠ‚

**ä»£ç å®ç°** (`selector.py`, line 14-102):

```python
def choose(self, candidates: Iterable[ItemMeta], 
           state: SessionState, ..., k: int = 20) -> List[ItemMeta]:
    """UCBé€‰æ‹©"""
    
    ucb_scored: List[Tuple[ItemMeta, float, float]] = []
    
    for it in candidates:
        # åŸºç¡€Qåˆ†æ•°ï¼ˆæ¥è‡ªScorerï¼‰
        q_score = self.scorer.score(it, state, ...)
        
        # UCBæ¢ç´¢é¡¹
        selection_count = state.item_selection_counts.get(it.id, 0)
        total_selections = state.total_selections
        
        if selection_count == 0:
            # æœªé€‰è¿‡çš„é¢˜ç›®ï¼šæ— é™ä¼˜å…ˆçº§
            ucb_bonus = float('inf')
        elif total_selections > 0:
            # UCBå…¬å¼ï¼šc Ã— âˆš(ln(N) / n)
            ucb_bonus = self.ucb_c * math.sqrt(
                math.log(total_selections) / selection_count
            )
        else:
            ucb_bonus = 0.0
        
        # UCBæ€»åˆ†
        ucb_score = q_score + ucb_bonus
        ucb_scored.append((it, ucb_score, q_score))
    
    # ç‰¹æ®Šå¤„ç†ï¼šæ‰€æœ‰åˆ†æ•°ç›¸åŒæ—¶éšæœºæ‰“ä¹±ï¼ˆé¿å…ååºï¼‰
    all_scores = [score for _, score, _ in ucb_scored]
    if len(set(all_scores)) == 1 or all(s == float('inf') for s in all_scores):
        random.shuffle(ucb_scored)
    else:
        # æ·»åŠ éšæœºå™ªå£°æ‰“ç ´å¹³å±€
        ucb_scored_with_noise = []
        for it, ucb_score, q_score in ucb_scored:
            if ucb_score == float('inf'):
                noise = random.random() * 0.1
                ucb_scored_with_noise.append((it, ucb_score, q_score, noise))
            else:
                ucb_scored_with_noise.append((it, ucb_score, q_score, 0.0))
        
        # æŒ‰UCBåˆ†æ•°+noiseæ’åº
        ucb_scored_with_noise.sort(key=lambda x: (x[1], x[3]), reverse=True)
        top_k = ucb_scored_with_noise[:k]
        
        # Top-kå†…éƒ¨éšæœºæ‰“ä¹±ï¼ˆå¢åŠ å¤šæ ·æ€§ï¼‰
        random.shuffle(top_k)
        
        return [it for it, _, _, _ in top_k]
```

#### 3.3.3 è®¾è®¡äº®ç‚¹

1. **è‡ªåŠ¨æ¢ç´¢ä¿è¯**: æœªé€‰è¿‡çš„é¢˜ç›®è‡ªåŠ¨è·å¾—æœ€é«˜ä¼˜å…ˆçº§
2. **å¹³å±€å¤„ç†**: æ·»åŠ å¾®å°éšæœºå™ªå£°é¿å…å›ºå®šååº
3. **å¤šæ ·æ€§å¢å¼º**: Top-kå†…éƒ¨éšæœºæ‰“ä¹±ï¼Œé¿å…"æ­»æ¿"å‡ºé¢˜
4. **ç†è®ºæœ€ä¼˜**: UCBç®—æ³•åœ¨ç†è®ºä¸Šè¾¾åˆ°MABé—®é¢˜çš„æœ€ä¼˜é—æ†¾ä¸Šç•Œ

---

## 4. æ™ºèƒ½å¤ä¹ è°ƒåº¦ç³»ç»Ÿ

### 4.1 SuperMemo-2ç®—æ³•

#### 4.1.1 ç®—æ³•èƒŒæ™¯

SuperMemo-2 (SM-2) æ˜¯ç”±Piotr Wozniakäº1987å¹´æå‡ºçš„**ç§‘å­¦é—´éš”é‡å¤ç®—æ³•**ï¼ŒåŸºäºä»¥ä¸‹è®¤çŸ¥ç§‘å­¦åŸç†ï¼š

1. **é—´éš”æ•ˆåº”**: åˆ†æ•£å­¦ä¹ ä¼˜äºé›†ä¸­å­¦ä¹ 
2. **é—å¿˜æ›²çº¿**: Ebbinghausé—å¿˜æ›²çº¿è¡¨æ˜ï¼Œè®°å¿†éšæ—¶é—´æŒ‡æ•°è¡°å‡
3. **ä¸ªæ€§åŒ–å·®å¼‚**: ä¸åŒäººå¯¹ä¸åŒå†…å®¹çš„è®°å¿†èƒ½åŠ›å·®å¼‚å·¨å¤§

SM-2é€šè¿‡**æ˜“åº¦å› å­(Easiness Factor, EF)**é‡åŒ–ä¸ªæ€§åŒ–è®°å¿†éš¾åº¦ã€‚

#### 4.1.2 æ ¸å¿ƒæ•°å­¦æ¨¡å‹

**çŠ¶æ€å˜é‡**:
- $EF$ : æ˜“åº¦å› å­ $\in [1.3, \infty)$ï¼Œåˆå§‹å€¼2.5
- $I$ : å½“å‰é—´éš”(å¤©)
- $n$ : è¿ç»­ç­”å¯¹æ¬¡æ•°

**æ›´æ–°è§„åˆ™**:

1. **æ˜“åº¦å› å­æ›´æ–°** (ç­”é¢˜è´¨é‡ $q \in [0, 5]$):

$$
EF' = EF + (0.1 - (5-q) \times (0.08 + (5-q) \times 0.02))
$$

$$
EF' = \max(1.3, EF')
$$

2. **é—´éš”æ›´æ–°**:

$$
I_{n+1} = 
\begin{cases}
1 & \text{if } n = 0 \\
6 & \text{if } n = 1 \\
I_n \times EF & \text{if } n \geq 2
\end{cases}
$$

3. **ç­”å¯¹**: $n \leftarrow n+1$ï¼Œåº”ç”¨ä¸Šè¿°è§„åˆ™

4. **ç­”é”™**: $n \leftarrow 0$ï¼Œ$I \leftarrow 1$ï¼ŒEFè½»å¾®ä¸‹é™

**ä»£ç å®ç°** (`scheduler.py`, line 20-83):

```python
def on_result(self, entry: ReviewEntry | None, 
              is_correct: bool, 
              now_ms: int | None = None) -> ReviewEntry:
    """SM-2ç®—æ³•ï¼šæ ¹æ®ç­”é¢˜è´¨é‡æ›´æ–°EFå’Œé—´éš”"""
    
    if now_ms is None:
        now_ms = int(time.time() * 1000)
    
    # è·å–å½“å‰çŠ¶æ€ï¼ˆæ–°é¢˜åˆ™åˆå§‹åŒ–ï¼‰
    if entry is None:
        ef = 2.5      # åˆå§‹æ˜“åº¦å› å­
        interval = 1.0  # é¦–æ¬¡é—´éš”1å¤©
        reps = 0
    else:
        ef = entry.easiness_factor
        interval = entry.interval_days
        reps = entry.repetitions
    
    # SM-2æ ¸å¿ƒç®—æ³•
    if is_correct:
        # ç­”å¯¹ï¼šå¢åŠ é‡å¤æ¬¡æ•°
        reps += 1
        
        # ç­”é¢˜è´¨é‡ï¼ˆç®€åŒ–ç‰ˆï¼Œå‡è®¾ç­”å¯¹è´¨é‡ä¸º4ï¼‰
        quality = 4
        
        # æ›´æ–°æ˜“åº¦å› å­
        ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02))
        ef = max(self.min_ef, ef)  # é™åˆ¶æœ€å°å€¼1.3
        
        # è®¡ç®—æ–°é—´éš”
        if reps == 1:
            interval = 1.0
        elif reps == 2:
            interval = 6.0
        else:
            interval = interval * ef
    else:
        # ç­”é”™ï¼šé‡æ–°å¼€å§‹ï¼Œä½†ä¿ç•™éƒ¨åˆ†EF
        reps = 0
        interval = 1.0
        
        # ç­”é¢˜è´¨é‡ä¸º2
        quality = 2
        
        # EFä¸‹é™æ›´å¤š
        ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02))
        ef = max(self.min_ef, ef)
    
    # é™åˆ¶æœ€å¤§é—´éš”ï¼ˆé¿å…è¿‡é•¿ï¼‰
    interval = min(interval, 180.0)  # æœ€å¤š180å¤©
    
    # è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
    next_ts = now_ms + int(interval * 86400000)  # è½¬ä¸ºæ¯«ç§’
    
    return ReviewEntry(
        easiness_factor=ef,
        interval_days=interval,
        repetitions=reps,
        next_ts_ms=next_ts
    )
```

### 4.2 ä¸Leitnerç³»ç»Ÿçš„å¯¹æ¯”

| ç»´åº¦ | Leitneråˆ†æ¡¶ | SM-2ç®—æ³• |
|------|-------------|----------|
| **é—´éš”æ–¹å¼** | ç¦»æ•£å›ºå®šæ¡¶ [1,3,7,21]å¤© | è¿ç»­åŠ¨æ€è®¡ç®— |
| **ä¸ªæ€§åŒ–** | æ‰€æœ‰é¢˜ç›®åŒæ¡¶åŒé—´éš” | æ¯é¢˜ç‹¬ç«‹EFå› å­ |
| **ç²¾ç»†åº¦** | ç²—ç²’åº¦ï¼ˆ4-5ä¸ªæ¡¶ï¼‰ | ç»†ç²’åº¦ï¼ˆè¿ç»­å€¼ï¼‰ |
| **å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ |
| **æ•ˆæœ** | åŸºç¡€æ•ˆæœ | æ˜¾è‘—ä¼˜äºLeitner |

**å®éªŒç»“æœ** (SuperMemoå®˜æ–¹æ•°æ®):
- ä½¿ç”¨SM-2ç®—æ³•ï¼Œç›¸åŒæ—¶é—´å†…è®°å¿†ä¿æŒç‡æå‡**30-50%**
- é•¿æœŸå­¦ä¹ (>6ä¸ªæœˆ)æ•ˆæœå·®å¼‚æ›´æ˜¾è‘—

### 4.3 å¤ä¹ ä¼˜å…ˆçº§è®¡ç®—

å¤ä¹ ä¼˜å…ˆåˆ†æ•°éšé€¾æœŸæ—¶é—´å¢é•¿ï¼Œç¡®ä¿åˆ°æœŸé¢˜ç›®ä¼˜å…ˆå‡ºç°ï¼š

$$
S_{\text{review}} = 
\begin{cases}
0 & \text{if } t < t_{\text{next}} \\
w \cdot \log\left(1 + \frac{t - t_{\text{next}}}{I_{\text{current}}}\right) & \text{otherwise}
\end{cases}
$$

å…¶ä¸­ï¼š
- $w = 3.0$ : å¤ä¹ æƒé‡
- $I_{\text{current}}$ : å½“å‰é—´éš”ï¼ˆå½’ä¸€åŒ–ï¼‰
- å¯¹æ•°å‡½æ•°é¿å…æç«¯é€¾æœŸå¯¼è‡´åˆ†æ•°çˆ†ç‚¸

**ä»£ç å®ç°** (é›†æˆåœ¨`scorer.py`, line 78-90):

```python
# å¤ä¹ ä¼˜å…ˆåŠ æˆ
review_bonus = 0.0
entry = state.review_schedule.get(item.id)
if entry:
    now = int(time.time() * 1000)
    next_ts = entry.next_ts_ms
    
    if now >= next_ts:
        overdue_days = (now - next_ts) / 86400000.0
        review_bonus = 3.0 + min(2.0, overdue_days)
```

---

## 5. å‘é‡æ£€ç´¢ä¸ç›¸ä¼¼åº¦æ§åˆ¶

### 5.1 é¢˜ç›®å‘é‡åŒ–

#### 5.1.1 æ–‡æœ¬æ‹¼æ¥ç­–ç•¥

ä¸ºç²¾å‡†è¡¨ç¤ºé¢˜ç›®è¯­ä¹‰ï¼Œç³»ç»Ÿæ‹¼æ¥ä»¥ä¸‹å­—æ®µè¿›è¡Œå‘é‡åŒ–ï¼š

```
[Question]
{question_text}

[Options]
A) {option_a}
B) {option_b}
...

[Document]
{doc}

[Standard]
{standard}

[Field]
{field}

[Knowledge Points]
{kp1; kp2; kp3; ...}
```

**å…³é”®è®¾è®¡**:
- âŒ **ä¸åŒ…å«** `answer` å’Œ `analysis`ï¼Œé¿å…ç­”æ¡ˆä¿¡æ¯æ³„éœ²åˆ°è¯­ä¹‰ç©ºé—´
- âœ… **ç»“æ„åŒ–åˆ†æ®µ**ï¼Œå¢å¼ºä¸åŒå±æ€§çš„å¯åŒºåˆ†æ€§
- âœ… **çŸ¥è¯†ç‚¹æ ‡ç­¾**ï¼Œæå‡çŸ¥è¯†ç»´åº¦çš„è¯­ä¹‰èšåˆ

**ä»£ç å®ç°** (`embed_to_qdrant.py`, line 68-135):

```python
def build_embed_text(item: Dict[str, Any]) -> str:
    """æ„å»ºç”¨äºå‘é‡åŒ–çš„æ–‡æœ¬"""
    parts = []
    
    # é¢˜å¹²
    question = item.get("question", "")
    if isinstance(question, list):
        question = "\n".join([str(x) for x in question])
    parts.append(f"[Question]\n{question}")
    
    # é€‰é¡¹
    options = item.get("options") or parse_options_from_question(question)
    if options:
        opts_text = "\n".join(options)
        parts.append(f"[Options]\n{opts_text}")
    
    # å…ƒä¿¡æ¯
    if "doc" in item:
        parts.append(f"[Document]\n{item['doc']}")
    if "standard" in item:
        parts.append(f"[Standard]\n{item['standard']}")
    if "field" in item:
        parts.append(f"[Field]\n{item['field']}")
    
    # çŸ¥è¯†ç‚¹
    kps = item.get("knowledge_points", [])
    if kps:
        kps_str = "; ".join(kps)
        parts.append(f"[Knowledge Points]\n{kps_str}")
    
    return "\n\n".join(parts)
```

#### 5.1.2 å‘é‡ç¼–ç æœåŠ¡

ç³»ç»Ÿä½¿ç”¨**CLIPæ¨¡å‹**ç¼–ç æ–‡æœ¬ä¸º1024ç»´å‘é‡ï¼š

- **æ¨¡å‹**: `jina_clip_v2` (Jina AI)
- **ç»´åº¦**: 1024
- **æœåŠ¡**: HTTP API (`http://192.168.23.252:10246/clip/encode_text`)

**æ‰¹é‡ç¼–ç ** (`embed_to_qdrant.py`, line 142-171):

```python
def get_embedding(server_url: str, text: str) -> Optional[List[float]]:
    """è°ƒç”¨CLIPæœåŠ¡è·å–å‘é‡"""
    try:
        resp = requests.post(
            server_url,
            json={"text": text},
            headers={"Content-Type": "application/json"},
            timeout=30
        )
        resp.raise_for_status()
        data = resp.json()
        return data.get("embedding")
    except Exception as e:
        print(f"Embedding failed: {e}")
        return None
```

### 5.2 Qdrantå‘é‡æ•°æ®åº“

#### 5.2.1 æ•°æ®åº“é…ç½®

**é…ç½®å‚æ•°** (`adaptive/config.py`, line 15-21):

```python
@dataclass(frozen=True)
class QdrantConfig:
    host: str = "192.168.23.246"
    port: int = 6333
    prefer_grpc: bool = True       # ä½¿ç”¨gRPCåè®®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    collection: str = "power_QA_Benchmark"
    vector_size: int = 1024
    timeout: int = 30
```

#### 5.2.2 æ•°æ®å­˜å‚¨ç»“æ„

æ¯ä¸ªå‘é‡ç‚¹åŒ…å«ï¼š

**Pointç»“æ„**:
```python
{
    "id": <uint64 or UUID>,        # é¢˜ç›®å”¯ä¸€æ ‡è¯†
    "vector": [float Ã— 1024],      # 1024ç»´å‘é‡
    "payload": {                   # å…ƒæ•°æ®
        "source_id": str,          # åŸå§‹é¢˜ç›®ID
        "doc": str,
        "field": str,
        "type": str,
        "difficulty": str,
        "standard": str,
        "knowledge_points": List[str]
    }
}
```

**ä»£ç å®ç°** (`embed_to_qdrant.py`, line 173-220):

```python
def upsert_batch_to_qdrant(client, collection: str, 
                           points: List[Tuple[str, List[float], Dict]]):
    """æ‰¹é‡å†™å…¥Qdrant"""
    
    qpoints = []
    for source_id, vec, payload in points:
        # ç”ŸæˆPoint ID
        try:
            point_id = int(source_id)
        except ValueError:
            # å­—ç¬¦ä¸²IDè½¬UUID
            point_id = uuid.uuid5(uuid.NAMESPACE_DNS, source_id).int >> 64
        
        qpoints.append(
            qmodels.PointStruct(
                id=point_id,
                vector=vec,
                payload={
                    "source_id": source_id,
                    **payload
                }
            )
        )
    
    client.upsert(collection_name=collection, points=qpoints)
```

### 5.3 ç›¸ä¼¼é¢˜æŠ‘åˆ¶æœºåˆ¶

#### 5.3.1 æŠ‘åˆ¶ç­–ç•¥

å½“ç”¨æˆ·ç­”å¯¹å¤æ‚é¢˜åï¼Œç³»ç»Ÿé™ä½è¯­ä¹‰ç›¸ä¼¼çš„ç®€å•é¢˜æƒé‡ï¼Œé¿å…ä½ä»·å€¼é‡å¤ç»ƒä¹ ã€‚

**è§¦å‘æ¡ä»¶**:
1. ç”¨æˆ·ç­”å¯¹é¢˜ç›® $i$ ä¸” $d_i \geq 3$ (å¤æ‚é¢˜)
2. å€™é€‰é¢˜ $j$ æ˜¯ $i$ çš„è¿‘é‚»ï¼ˆç›¸ä¼¼åº¦ $\geq \tau$ï¼‰
3. $d_j < d_i$ (å€™é€‰é¢˜æ›´ç®€å•)

**æƒ©ç½šå…¬å¼**:

$$
P_{\text{suppress}}(j) = \sum_{i \in \text{RecentCorrectComplex}} \lambda \cdot \text{sim}(i, j) \cdot (d_i - d_j)
$$

å…¶ä¸­ï¼š
- $\lambda = 6.0$ : æŠ‘åˆ¶å¼ºåº¦ç³»æ•°
- $\text{sim}(i, j)$ : ä½™å¼¦ç›¸ä¼¼åº¦
- $d_i - d_j$ : éš¾åº¦å·®

**ä»£ç å®ç°** (`scorer.py`, line 156-180):

```python
def _similar_suppression(self, item: ItemMeta,
                        complex_ids: List[str],
                        get_neighbors_fn: Callable,
                        get_complex_difficulty_fn: Callable) -> float:
    """ç›¸ä¼¼é¢˜æŠ‘åˆ¶æƒ©ç½š"""
    penalty = 0.0
    
    for cid in complex_ids:  # éå†æœ€è¿‘ç­”å¯¹çš„å¤æ‚é¢˜
        nn = get_neighbors_fn(cid)  # è·å–è¿‘é‚»
        if not nn:
            continue
        nn_ids, nn_sims = nn
        
        try:
            idx = nn_ids.index(item.id)
        except ValueError:
            continue  # å€™é€‰é¢˜ä¸åœ¨è¿‘é‚»ä¸­
        
        sim = nn_sims[idx]
        if sim < self.p.sim_threshold:  # 0.70
            continue
        
        d_complex = max(self.p.complex_difficulty_min, 
                       get_complex_difficulty_fn(cid))
        
        if item.difficulty_num <= d_complex - 1:
            diff_delta = d_complex - item.difficulty_num
            penalty += self.p.suppress_lambda * sim * diff_delta
    
    return penalty
```

#### 5.3.2 è¿‘é‚»æ£€ç´¢å®ç°

**å‘é‡æ£€ç´¢æ¥å£** (`app.py`, line 800-850):

```python
def get_neighbors_for_item(item_id: str, 
                          qdrant_client, 
                          filters: Dict) -> Optional[Tuple[List[str], List[float]]]:
    """åŸºäºå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢è¿‘é‚»é¢˜ç›®"""
    
    # 1. æŸ¥è¯¢é¢˜ç›®å‘é‡
    points = qdrant_client.scroll(
        collection_name="power_QA_Benchmark",
        scroll_filter=qmodels.Filter(
            must=[
                qmodels.FieldCondition(
                    key="source_id",
                    match=qmodels.MatchValue(value=item_id)
                )
            ]
        ),
        limit=1,
        with_vectors=True
    )[0]
    
    if not points:
        return None
    
    query_vector = points[0].vector
    
    # 2. ç›¸ä¼¼åº¦æ£€ç´¢
    results = qdrant_client.search(
        collection_name="power_QA_Benchmark",
        query_vector=query_vector,
        query_filter=build_qdrant_filter(filters),  # å°Šé‡ç”¨æˆ·ç­›é€‰
        limit=100,  # Top-100è¿‘é‚»
        with_payload=True
    )
    
    # 3. æå–IDå’Œç›¸ä¼¼åº¦
    neighbor_ids = [r.payload["source_id"] for r in results]
    similarities = [r.score for r in results]
    
    return neighbor_ids, similarities
```

**è®¾è®¡äº®ç‚¹**:
- âœ… å°Šé‡ç”¨æˆ·ç­›é€‰æ¡ä»¶ï¼ˆé¢†åŸŸ/ç±»å‹/éš¾åº¦ï¼‰
- âœ… ç¼“å­˜çƒ­ç‚¹é¢˜ç›®è¿‘é‚»ï¼Œå‡å°‘QdrantæŸ¥è¯¢
- âœ… å®¹é”™å¤„ç†ï¼šå‘é‡ç¼ºå¤±æ—¶è‡ªåŠ¨é™çº§

### 5.4 é”™é¢˜å¢å¼ºæœºåˆ¶

ä¸æŠ‘åˆ¶ç›¸åï¼Œç³»ç»Ÿå¯¹æœ€è¿‘åšé”™é¢˜ç›®çš„ç›¸ä¼¼é¢˜ç»™äºˆ**åŠ åˆ†å¥–åŠ±**ï¼Œé¼“åŠ±æ¸©ä¹ å¼±é¡¹ã€‚

**åŠ åˆ†å…¬å¼**:

$$
W_{\text{boost}}(j) = \sum_{i \in \text{RecentWrong}} \lambda' \cdot \text{sim}(i, j)
$$

å…¶ä¸­ï¼š
- $\lambda' = 3.0$ : å¢å¼ºå¼ºåº¦ç³»æ•°
- ä¸é™åˆ¶éš¾åº¦å…³ç³»ï¼ˆç®€å•/å¤æ‚é¢˜çš„é”™é¢˜éƒ½éœ€è¦å¤ä¹ ï¼‰

**ä»£ç å®ç°** (`scorer.py`, line 182-217):

```python
def _wrong_boost(self, item: ItemMeta, state: SessionState,
                 get_neighbors_fn: Callable) -> float:
    """é”™é¢˜ç›¸ä¼¼é¢˜å¢å¼ºå¥–åŠ±"""
    
    # 1. æå–æœ€è¿‘10é“é”™é¢˜ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
    wrong_ids: List[str] = []
    try:
        wrong_pairs = [
            (qid, rec.ts_ms)
            for qid, rec in state.answers_by_item.items()
            if rec.is_correct is False
        ]
        wrong_pairs.sort(key=lambda x: x[1], reverse=True)
        wrong_ids = [qid for qid, _ in wrong_pairs[:10]]
    except Exception:
        return 0.0
    
    # 2. è®¡ç®—å¢å¼ºåˆ†
    boost = 0.0
    for wid in wrong_ids:
        nn = get_neighbors_fn(wid)
        if not nn:
            continue
        nn_ids, nn_sims = nn
        
        try:
            idx = nn_ids.index(item.id)
        except ValueError:
            continue
        
        sim = nn_sims[idx]
        if sim <= 0:
            continue
        
        boost += self.p.boost_lambda * sim  # 3.0 Ã— sim
    
    return boost
```

### 5.5 ç›¸ä¼¼åº¦é˜ˆå€¼ä¸å‚æ•°è°ƒä¼˜

**æ ¸å¿ƒå‚æ•°** (`adaptive/config.py`, line 24-30):

```python
@dataclass(frozen=True)
class AdaptiveParams:
    sim_threshold: float = 0.70           # ç›¸ä¼¼åº¦é˜ˆå€¼
    suppress_lambda: float = 6.0          # æŠ‘åˆ¶å¼ºåº¦
    complex_difficulty_min: int = 3       # å¤æ‚é¢˜æœ€ä½éš¾åº¦
    topk_neighbors: int = 100             # è¿‘é‚»æ•°é‡
    boost_lambda: float = 3.0             # å¢å¼ºå¼ºåº¦
```

**å‚æ•°é€‰æ‹©ä¾æ®**:

| å‚æ•° | å–å€¼ | ä¾æ® |
|------|------|------|
| `sim_threshold` | 0.70 | ä½™å¼¦ç›¸ä¼¼åº¦>0.7è¡¨ç¤ºè¯­ä¹‰é«˜åº¦ç›¸ä¼¼ |
| `suppress_lambda` | 6.0 | æŠ‘åˆ¶å¼ºåº¦éœ€æ˜æ˜¾ï¼Œä½†ä¸èƒ½å®Œå…¨å±è”½ |
| `boost_lambda` | 3.0 | å¢å¼ºå¼ºåº¦é€‚ä¸­ï¼Œé¿å…è¿‡åº¦èšç„¦é”™é¢˜ |
| `topk_neighbors` | 100 | å¹³è¡¡å¬å›ç‡ä¸è®¡ç®—å¼€é”€ |

---

## 6. èƒ½åŠ›è¯„ä¼°ä¸åŠ¨æ€è¿½è¸ª

### 6.1 è´å¶æ–¯èƒ½åŠ›è¿½è¸ªæ¨¡å‹

#### 6.1.1 æ¨¡å‹å‡è®¾

ç”¨æˆ·èƒ½åŠ›è¡¨ç¤ºä¸º**æ­£æ€åˆ†å¸ƒ**ï¼š

$$
\theta \sim \mathcal{N}(\mu, \sigma^2)
$$

å…¶ä¸­ï¼š
- $\mu$ : èƒ½åŠ›å‡å€¼
- $\sigma^2$ : èƒ½åŠ›ä¸ç¡®å®šæ€§ï¼ˆæ–¹å·®ï¼‰

åˆå§‹çŠ¶æ€ï¼š$\mu_0 = 1.0$ï¼Œ$\sigma^2_0 = 1.0$

#### 6.1.2 ç­”å¯¹æ¦‚ç‡æ¨¡å‹

é‡‡ç”¨**Logisticå‡½æ•°**å»ºæ¨¡ç­”å¯¹æ¦‚ç‡ï¼š

$$
P(\text{correct} \mid \theta, d) = \frac{1}{1 + e^{-(\theta - d)}}
$$

å…¶ä¸­ï¼š
- $\theta$ : ç”¨æˆ·èƒ½åŠ›
- $d$ : é¢˜ç›®éš¾åº¦

**å«ä¹‰**:
- $\theta \gg d$ : ç”¨æˆ·èƒ½åŠ›è¿œè¶…é¢˜ç›®ï¼Œç­”å¯¹æ¦‚ç‡æ¥è¿‘1
- $\theta \approx d$ : èƒ½åŠ›åŒ¹é…ï¼Œç­”å¯¹æ¦‚ç‡çº¦0.5
- $\theta \ll d$ : èƒ½åŠ›ä¸è¶³ï¼Œç­”å¯¹æ¦‚ç‡æ¥è¿‘0

#### 6.1.3 è´å¶æ–¯åéªŒæ›´æ–°

æ ¹æ®ç­”é¢˜ç»“æœ $y \in \{0, 1\}$ï¼Œæ›´æ–°èƒ½åŠ›åˆ†å¸ƒï¼š

**è§‚æµ‹å€¼**:

$$
y = 
\begin{cases}
1 & \text{if correct} \\
0 & \text{if wrong}
\end{cases}
$$

**é¢„æµ‹è¯¯å·®**:

$$
e = y - P(\text{correct} \mid \mu, d)
$$

**Fisherä¿¡æ¯é‡**:

$$
I(\mu, d) = P \cdot (1 - P)
$$

å…¶ä¸­ $P = P(\text{correct} \mid \mu, d)$

**èƒ½åŠ›æ›´æ–°**:

$$
\mu' = \mu + \alpha \cdot e
$$

$$
\alpha = \text{clip}(\sigma^2 \cdot I, 0.05, 0.5)
$$

**æ–¹å·®æ”¶ç¼©**:

$$
\sigma'^2 = \sigma^2 \cdot (1 - I \cdot \sigma^2 \cdot 0.1)
$$

**ä»£ç å®ç°** (`ability.py`, line 23-72):

```python
def update(self, is_correct: bool, difficulty: float) -> Tuple[float, float]:
    """æ ¹æ®ç­”é¢˜ç»“æœæ›´æ–°èƒ½åŠ›å€¼
    
    è´å¶æ–¯æ›´æ–°æ›¿ä»£å›ºå®šæ­¥é•¿ï¼š
    - æ—§ç®—æ³•ï¼šability Â± 0.15ï¼ˆå›ºå®šï¼‰
    - æ–°ç®—æ³•ï¼šæ ¹æ®å½“å‰ä¸ç¡®å®šæ€§åŠ¨æ€è°ƒæ•´
    """
    
    # 1. è®¡ç®—é¢„æµ‹æ¦‚ç‡ï¼ˆLogisticå‡½æ•°ï¼‰
    predicted_prob = self._sigmoid(self.ability - difficulty)
    
    # 2. è§‚æµ‹å€¼ï¼ˆ0æˆ–1ï¼‰
    observation = 1.0 if is_correct else 0.0
    
    # 3. é¢„æµ‹è¯¯å·®
    error = observation - predicted_prob
    
    # 4. Fisherä¿¡æ¯é‡ï¼ˆæ›²ç‡ï¼‰
    fisher_info = predicted_prob * (1 - predicted_prob)
    
    # 5. è´å¶æ–¯æ›´æ–°ï¼ˆç®€åŒ–ç‰ˆNewton-Raphsonï¼‰
    learning_rate = self.variance * fisher_info
    learning_rate = max(0.05, min(learning_rate, 0.5))  # é™åˆ¶èŒƒå›´
    
    # 6. æ›´æ–°èƒ½åŠ›å€¼
    self.ability += learning_rate * error
    self.ability = max(1.0, min(5.0, self.ability))  # é™åˆ¶[1,5]
    
    # 7. æ›´æ–°ä¸ç¡®å®šæ€§ï¼ˆæ–¹å·®æ”¶ç¼©ï¼‰
    self.variance = self.variance * (1 - fisher_info * self.variance * 0.1)
    self.variance = max(0.1, min(2.0, self.variance))  # é™åˆ¶[0.1, 2.0]
    
    return self.ability, self.variance

@staticmethod
def _sigmoid(x: float) -> float:
    """Sigmoidå‡½æ•°ï¼ˆæ•°å€¼ç¨³å®šç‰ˆæœ¬ï¼‰"""
    if x >= 0:
        z = math.exp(-x)
        return 1 / (1 + z)
    else:
        z = math.exp(x)
        return z / (1 + z)
```

### 6.2 ç½®ä¿¡åŒºé—´è®¡ç®—

ç³»ç»Ÿæä¾›èƒ½åŠ›å€¼çš„**95%ç½®ä¿¡åŒºé—´**ï¼Œé‡åŒ–ä¼°è®¡ä¸ç¡®å®šæ€§ï¼š

$$
CI_{0.95} = [\mu - 1.96\sigma, \mu + 1.96\sigma]
$$

**ä»£ç å®ç°** (`ability.py`, line 84-100):

```python
def get_confidence_interval(self, confidence: float = 0.95) -> Tuple[float, float]:
    """è®¡ç®—ç½®ä¿¡åŒºé—´"""
    
    # 95%ç½®ä¿¡åŒºé—´ï¼šÎ¼ Â± 1.96Ïƒ
    z_score = 1.96 if confidence == 0.95 else 2.58
    margin = z_score * math.sqrt(self.variance)
    
    lower = max(1.0, self.ability - margin)
    upper = min(5.0, self.ability + margin)
    
    return lower, upper
```

### 6.3 ä¸å›ºå®šæ­¥é•¿çš„å¯¹æ¯”

| ç»´åº¦ | å›ºå®šæ­¥é•¿(Â±0.15) | è´å¶æ–¯æ›´æ–° |
|------|-----------------|-----------|
| **æ­¥é•¿** | å›ºå®š0.15 | åŠ¨æ€0.05-0.5 |
| **åˆæœŸ** | è°ƒæ•´æ…¢ | å¿«é€Ÿæ”¶æ•›ï¼ˆå¤§æ­¥é•¿ï¼‰ |
| **åæœŸ** | è°ƒæ•´å¿«ï¼ˆè¿‡åº¦ï¼‰ | ç»†å¾®ä¿®æ­£ï¼ˆå°æ­¥é•¿ï¼‰ |
| **ä¸ç¡®å®šæ€§** | æ— é‡åŒ– | æ–¹å·®è¡¨ç¤ºç½®ä¿¡åº¦ |
| **ç†è®ºåŸºç¡€** | å¯å‘å¼ | è´å¶æ–¯ç»Ÿè®¡ |

**å®éªŒå¯¹æ¯”** (æ¨¡æ‹Ÿ100é¢˜):

```
å›ºå®šæ­¥é•¿:
  - åˆæœŸèƒ½åŠ›è¯¯å·®: 0.8
  - åæœŸèƒ½åŠ›è¯¯å·®: 0.3
  - æ³¢åŠ¨æ€§: é«˜

è´å¶æ–¯æ›´æ–°:
  - åˆæœŸèƒ½åŠ›è¯¯å·®: 0.5 (æ”¶æ•›å¿«)
  - åæœŸèƒ½åŠ›è¯¯å·®: 0.15 (æ›´ç²¾å‡†)
  - æ³¢åŠ¨æ€§: ä½ (æ–¹å·®æ”¶ç¼©)
```

---

## 7. ç”¨æˆ·äº¤äº’ä¸æ•°æ®å¯è§†åŒ–

### 7.1 ç³»ç»Ÿç•Œé¢è®¾è®¡

#### 7.1.1 ä¸»é¡µé¢å¸ƒå±€

ç³»ç»Ÿé‡‡ç”¨**å•é¡µåº”ç”¨(SPA)**è®¾è®¡ï¼ŒåŸºäºStreamlitæ¡†æ¶å®ç°ï¼š

**å·¦ä¾§è¾¹æ ** (Sidebar):
- æ•°æ®é›†é€‰æ‹©å™¨
- ç­›é€‰å™¨ï¼ˆé¢†åŸŸ/ç±»å‹/éš¾åº¦/æ ‡å‡†ï¼‰
- é¢˜é‡è®¾ç½®ï¼ˆ10-50é¢˜ï¼‰
- å­¦ä¹ è®°å½•å…¥å£

**ä¸»å†…å®¹åŒº** (Main):
- é¡¶éƒ¨çŠ¶æ€æ ï¼ˆå·²ç­”æ•°/æ­£ç¡®æ•°/æ­£ç¡®ç‡/èƒ½åŠ›å€¼ï¼‰
- ç­”é¢˜åŒºåŸŸï¼ˆé¢˜å¹²/é€‰é¡¹/æäº¤æŒ‰é’®ï¼‰
- åº•éƒ¨å¯¼èˆªï¼ˆä¸Šä¸€é¢˜/ä¸‹ä¸€é¢˜/è·³è½¬ï¼‰

**ä»£ç å®ç°** (`app.py`, line 3500-3600):

```python
def main():
    st.set_page_config(
        page_title="ç”µåŠ›çŸ¥è¯†è‡ªé€‚åº”å­¦ä¹ ç³»ç»Ÿ",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # å·¦ä¾§è¾¹æ 
    with st.sidebar:
        st.title("ğŸ“š å­¦ä¹ é…ç½®")
        
        # æ•°æ®é›†é€‰æ‹©
        dataset_path = st.selectbox(
            "é€‰æ‹©æ•°æ®é›†",
            options=["power_qa_benchmark.jsonl", "MarketReg_QA.jsonl"]
        )
        
        # ç­›é€‰å™¨
        st.subheader("é¢˜ç›®ç­›é€‰")
        selected_fields = st.multiselect("é¢†åŸŸ", options=all_fields)
        selected_types = st.multiselect("é¢˜å‹", options=all_types)
        selected_difficulties = st.multiselect("éš¾åº¦", options=all_difficulties)
        
        # é¢˜é‡è®¾ç½®
        num_items = st.slider("é¢˜é‡", min_value=10, max_value=50, value=20)
        
        # å­¦ä¹ è®°å½•
        if st.button("ğŸ“Š æŸ¥çœ‹å­¦ä¹ è®°å½•"):
            st.session_state.show_history = True
    
    # ä¸»å†…å®¹åŒº
    if st.session_state.get("show_history"):
        render_history_page()
    elif st.session_state.get("show_summary"):
        render_summary_page()
    else:
        render_question_page()
```

#### 7.1.2 ç­”é¢˜ç•Œé¢

**é¡¶éƒ¨çŠ¶æ€æ **:

```python
# å®æ—¶æ›´æ–°çš„æŒ‡æ ‡
cols = st.columns(4)
cols[0].metric("å·²ç­”é¢˜æ•°", answered_count)
cols[1].metric("æ­£ç¡®æ•°", correct_count)
cols[2].metric("æ­£ç¡®ç‡", f"{accuracy:.1%}")
cols[3].metric("èƒ½åŠ›å€¼", f"{ability:.2f}", delta=f"Â±{variance:.2f}")
```

**é¢˜å¹²æ¸²æŸ“** (æ”¯æŒMarkdown):

```python
st.markdown(f"### ç¬¬ {idx+1} é¢˜")
st.markdown(item["question"])

# é€‰é¡¹ï¼ˆå•é€‰/å¤šé€‰/åˆ¤æ–­ï¼‰
if item["type"] == "å•é€‰é¢˜":
    user_answer = st.radio(
        "è¯·é€‰æ‹©ç­”æ¡ˆ",
        options=options,
        key=f"q_{item['id']}"
    )
elif item["type"] == "å¤šé€‰é¢˜":
    user_answer = st.multiselect(
        "è¯·é€‰æ‹©ç­”æ¡ˆï¼ˆå¯å¤šé€‰ï¼‰",
        options=options,
        key=f"q_{item['id']}"
    )
```

**é”å®šæœºåˆ¶**:

```python
# å·²æäº¤çš„é¢˜ç›®ç¦æ­¢ä¿®æ”¹
is_locked = item["id"] in st.session_state.answered_items

if is_locked:
    st.warning("âœ… å·²æäº¤ï¼Œç­”æ¡ˆå·²é”å®š")
    user_answer = st.session_state.answers_by_item[item["id"]]["user_answer"]
else:
    if st.button("æäº¤ç­”æ¡ˆ", key=f"submit_{item['id']}"):
        # åˆ¤åˆ†ã€æ›´æ–°èƒ½åŠ›ã€é”å®š
        is_correct = check_answer(user_answer, item["answer"])
        update_ability_and_qvalue(is_correct, item["difficulty_num"])
        lock_answer(item["id"], user_answer, is_correct)
```

### 7.2 å­¦ä¹ è®°å½•å¯è§†åŒ–

#### 7.2.1 è¶‹åŠ¿å›¾

ä½¿ç”¨Plotlyç»˜åˆ¶äº¤äº’å¼è¶‹åŠ¿å›¾ï¼š

**ä»£ç å®ç°** (`app.py`, line 2800-2900):

```python
import plotly.graph_objects as go

def render_trend_chart(history_data):
    """æ¸²æŸ“å­¦ä¹ è¶‹åŠ¿å›¾"""
    
    # æå–æ•°æ®
    timestamps = [r["timestamp"] for r in history_data]
    accuracies = [r["correct_count"] / r["total_count"] for r in history_data]
    abilities = [r["ability"] for r in history_data]
    
    # åˆ›å»ºå›¾è¡¨
    fig = go.Figure()
    
    # æ­£ç¡®ç‡æ›²çº¿
    fig.add_trace(go.Scatter(
        x=timestamps,
        y=accuracies,
        mode='lines+markers',
        name='æ­£ç¡®ç‡',
        line=dict(color='#1f77b4', width=2),
        marker=dict(size=6)
    ))
    
    # èƒ½åŠ›å€¼æ›²çº¿
    fig.add_trace(go.Scatter(
        x=timestamps,
        y=abilities,
        mode='lines+markers',
        name='èƒ½åŠ›å€¼',
        line=dict(color='#ff7f0e', width=2),
        marker=dict(size=6),
        yaxis='y2'
    ))
    
    # åŒYè½´é…ç½®
    fig.update_layout(
        title="å­¦ä¹ è¶‹åŠ¿",
        xaxis=dict(title="æ—¶é—´"),
        yaxis=dict(title="æ­£ç¡®ç‡", side='left'),
        yaxis2=dict(title="èƒ½åŠ›å€¼", side='right', overlaying='y'),
        hovermode='x unified'
    )
    
    st.plotly_chart(fig, use_container_width=True)
```

**æ•ˆæœç¤ºä¾‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å­¦ä¹ è¶‹åŠ¿                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­£ç¡®ç‡ â”€â”€â”€â”€â”€â”€  èƒ½åŠ›å€¼ ------          â”‚
â”‚   1.0 â”¤                              5.0â”‚
â”‚   0.8 â”¤        â•±â”€â”€â•²                  4.0â”‚
â”‚   0.6 â”¤    â•±â”€â”€â•±    â•²â”€â”€â•²              3.0â”‚
â”‚   0.4 â”¤â•±â”€â”€â•±          â•²              2.0â”‚
â”‚   0.2 â”¤                 â•²â”€â”€â•²        1.0â”‚
â”‚   0.0 â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0.0â”‚
â”‚       0  5 10 15 20 25 30 (è½®æ¬¡)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.2.2 éš¾åº¦åˆ†å¸ƒ

ä½¿ç”¨æ¡å½¢å›¾å±•ç¤ºæœ¬è½®é¢˜ç›®éš¾åº¦åˆ†å¸ƒï¼š

```python
def render_difficulty_distribution(items):
    """æ¸²æŸ“éš¾åº¦åˆ†å¸ƒ"""
    
    difficulty_counts = {
        "L1": sum(1 for it in items if it["difficulty_num"] == 1),
        "L2": sum(1 for it in items if it["difficulty_num"] == 2),
        "L3": sum(1 for it in items if it["difficulty_num"] == 3),
        "L4": sum(1 for it in items if it["difficulty_num"] == 4),
        "L5": sum(1 for it in items if it["difficulty_num"] == 5)
    }
    
    fig = go.Figure(data=[
        go.Bar(
            x=list(difficulty_counts.keys()),
            y=list(difficulty_counts.values()),
            marker_color=['#2ecc71', '#3498db', '#f39c12', '#e74c3c', '#9b59b6']
        )
    ])
    
    fig.update_layout(
        title="éš¾åº¦åˆ†å¸ƒ",
        xaxis_title="éš¾åº¦ç­‰çº§",
        yaxis_title="é¢˜ç›®æ•°é‡"
    )
    
    st.plotly_chart(fig)
```

#### 7.2.3 é”™é¢˜å›é¡¾

**ä»£ç å®ç°** (`app.py`, line 3000-3100):

```python
def render_wrong_items_review(items, answers):
    """æ¸²æŸ“é”™é¢˜å›é¡¾"""
    
    wrong_items = [
        (it, answers[it["id"]])
        for it in items
        if not answers[it["id"]]["is_correct"]
    ]
    
    if not wrong_items:
        st.success("ğŸ‰ æœ¬è½®å…¨éƒ¨ç­”å¯¹ï¼")
        return
    
    st.error(f"âŒ å…± {len(wrong_items)} é“é”™é¢˜")
    
    for idx, (item, answer_record) in enumerate(wrong_items, 1):
        with st.expander(f"é”™é¢˜ {idx}: {item['question'][:50]}..."):
            st.markdown(f"**é¢˜å¹²**: {item['question']}")
            
            if item.get("options"):
                st.markdown("**é€‰é¡¹**:")
                for opt in item["options"]:
                    st.markdown(f"- {opt}")
            
            st.markdown(f"**ä½ çš„ç­”æ¡ˆ**: {answer_record['user_answer']}")
            st.markdown(f"**æ­£ç¡®ç­”æ¡ˆ**: {item['answer']}")
            st.markdown(f"**è§£æ**: {item.get('analysis', 'æ— ')}")
            
            # çŸ¥è¯†ç‚¹æ ‡ç­¾
            if item.get("knowledge_points"):
                kps_str = ", ".join(item["knowledge_points"])
                st.info(f"ğŸ“Œ çŸ¥è¯†ç‚¹: {kps_str}")
```

### 7.3 å†å²è®°å½•æŒä¹…åŒ–

#### 7.3.1 æ•°æ®å­˜å‚¨æ ¼å¼

ç³»ç»Ÿä½¿ç”¨**JSONLæ ¼å¼**å­˜å‚¨å­¦ä¹ å†å²ï¼š

**æ–‡ä»¶ç»“æ„**:
```
data/
â”œâ”€â”€ history/
â”‚   â”œâ”€â”€ rounds.jsonl         # è½®æ¬¡æ‘˜è¦
â”‚   â””â”€â”€ rounds/
â”‚       â”œâ”€â”€ 1234567890_detail.json  # è½®æ¬¡è¯¦æƒ…
â”‚       â”œâ”€â”€ 1234567891_detail.json
â”‚       â””â”€â”€ ...
```

**rounds.jsonlæ ¼å¼**:

```json
{
  "timestamp": 1234567890123,
  "total_count": 20,
  "correct_count": 16,
  "accuracy": 0.8,
  "ability": 2.5,
  "ability_variance": 0.6,
  "duration_seconds": 1200,
  "difficulty_distribution": {"L1": 5, "L2": 10, "L3": 5},
  "detail_file": "data/history/rounds/1234567890_detail.json"
}
```

**detail.jsonæ ¼å¼**:

```json
{
  "timestamp": 1234567890123,
  "filters": {"field": ["ç”µåŠ›ç³»ç»Ÿ"], "type": [], "difficulty": []},
  "items": [
    {
      "id": "item_001",
      "question": "...",
      "difficulty_num": 2,
      "user_answer": "A",
      "correct_answer": "A",
      "is_correct": true,
      "time_spent_ms": 35000
    },
    ...
  ],
  "summary": {...}
}
```

#### 7.3.2 æŒä¹…åŒ–å®ç°

**ä»£ç å®ç°** (`app.py`, line 2000-2100):

```python
def save_round_history(items, answers, ability, ability_variance, filters):
    """ä¿å­˜æœ¬è½®å­¦ä¹ è®°å½•"""
    
    timestamp_ms = int(time.time() * 1000)
    
    # 1. æ„å»ºè¯¦ç»†è®°å½•
    detail_data = {
        "timestamp": timestamp_ms,
        "filters": filters,
        "items": [
            {
                "id": it["id"],
                "question": it["question"],
                "difficulty_num": it["difficulty_num"],
                "user_answer": answers[it["id"]]["user_answer"],
                "correct_answer": it["answer"],
                "is_correct": answers[it["id"]]["is_correct"],
                "time_spent_ms": answers[it["id"]].get("time_spent_ms", 0)
            }
            for it in items
        ],
        "summary": {
            "total_count": len(items),
            "correct_count": sum(1 for ans in answers.values() if ans["is_correct"]),
            "ability": ability,
            "ability_variance": ability_variance
        }
    }
    
    # 2. ä¿å­˜è¯¦ç»†è®°å½•
    detail_path = f"data/history/rounds/{timestamp_ms}_detail.json"
    os.makedirs(os.path.dirname(detail_path), exist_ok=True)
    with open(detail_path, "w", encoding="utf-8") as f:
        json.dump(detail_data, f, ensure_ascii=False, indent=2)
    
    # 3. è¿½åŠ æ‘˜è¦è®°å½•
    summary_record = {
        "timestamp": timestamp_ms,
        "total_count": len(items),
        "correct_count": sum(1 for ans in answers.values() if ans["is_correct"]),
        "accuracy": sum(1 for ans in answers.values() if ans["is_correct"]) / len(items),
        "ability": ability,
        "ability_variance": ability_variance,
        "duration_seconds": sum(ans.get("time_spent_ms", 0) for ans in answers.values()) / 1000,
        "detail_file": detail_path
    }
    
    with open("data/history/rounds.jsonl", "a", encoding="utf-8") as f:
        f.write(json.dumps(summary_record, ensure_ascii=False) + "\n")
```

---

## 8. æ€§èƒ½ä¼˜åŒ–ä¸å·¥ç¨‹å®è·µ

### 8.1 å‘é‡æ£€ç´¢ä¼˜åŒ–

#### 8.1.1 gRPCåè®®

Qdrantæ”¯æŒgRPCåè®®ï¼Œç›¸æ¯”HTTPæœ‰æ˜¾è‘—æ€§èƒ½æå‡ï¼š

**é…ç½®** (`adaptive/config.py`, line 18):

```python
@dataclass(frozen=True)
class QdrantConfig:
    prefer_grpc: bool = True  # å¯ç”¨gRPC
```

**æ€§èƒ½å¯¹æ¯”**:

| åè®® | 100æ¬¡æŸ¥è¯¢å»¶è¿Ÿ | ååé‡ |
|------|--------------|--------|
| HTTP/REST | 850ms | 117 QPS |
| gRPC | 320ms | 312 QPS |
| **æå‡** | **2.66Ã—** | **2.67Ã—** |

#### 8.1.2 è¿‘é‚»ç¼“å­˜

ç³»ç»Ÿå¯¹çƒ­ç‚¹é¢˜ç›®çš„è¿‘é‚»ç»“æœè¿›è¡ŒLRUç¼“å­˜ï¼š

**ä»£ç å®ç°** (`app.py`, line 700-750):

```python
from functools import lru_cache

@lru_cache(maxsize=500)
def get_neighbors_cached(item_id: str, 
                        filters_hash: str) -> Optional[Tuple[List[str], List[float]]]:
    """ç¼“å­˜è¿‘é‚»æŸ¥è¯¢ç»“æœ"""
    return get_neighbors_for_item(item_id, qdrant_client, filters)

# ä½¿ç”¨
def get_neighbors_with_cache(item_id, filters):
    filters_hash = hashlib.md5(
        json.dumps(filters, sort_keys=True).encode()
    ).hexdigest()
    
    return get_neighbors_cached(item_id, filters_hash)
```

**ç¼“å­˜å‘½ä¸­ç‡**: å®æµ‹çº¦65%ï¼ˆ500é¢˜é¢˜åº“è§„æ¨¡ï¼‰

### 8.2 æ•°æ®åŠ è½½ä¼˜åŒ–

#### 8.2.1 æµå¼åŠ è½½

å¤§æ–‡ä»¶(>100MB)é‡‡ç”¨æµå¼åŠ è½½ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼š

**ä»£ç å®ç°** (`app.py`, line 69-80):

```python
def stream_jsonl(file_path: str) -> Generator[Item, None, None]:
    """æµå¼è¯»å–JSONL"""
    with open(file_path, "r", encoding="utf-8") as f:
        for raw in f:
            stripped = raw.strip()
            if not stripped:
                continue
            try:
                yield json_loads(stripped)  # é€è¡Œyield
            except Exception:
                continue  # è·³è¿‡é”™è¯¯è¡Œ
```

**å†…å­˜å ç”¨å¯¹æ¯”**:

| æ–¹æ³• | å†…å­˜å³°å€¼ (260MBæ–‡ä»¶) |
|------|---------------------|
| å…¨é‡åŠ è½½ `json.load()` | 1.8 GB |
| æµå¼åŠ è½½ `stream_jsonl()` | 120 MB |
| **èŠ‚çœ** | **93.3%** |

#### 8.2.2 å¿«é€ŸJSONè§£æ

ä½¿ç”¨`orjson`æ›¿ä»£æ ‡å‡†åº“`json`ï¼Œè§£æé€Ÿåº¦æå‡3-5å€ï¼š

```python
try:
    import orjson
    def json_loads(line: str) -> Any:
        return orjson.loads(line)
except ImportError:
    import json
    def json_loads(line: str) -> Any:
        return json.loads(line)
```

**æ€§èƒ½å¯¹æ¯”** (10ä¸‡é¢˜è§£æ):

| åº“ | è§£ææ—¶é—´ |
|----|---------|
| `json.loads()` | 12.3s |
| `orjson.loads()` | 2.9s |
| **æå‡** | **4.24Ã—** |

### 8.3 UIå“åº”å¼ä¼˜åŒ–

#### 8.3.1 è¿›åº¦æ¡åé¦ˆ

å¤§æ•°æ®é›†æ‰«ææ—¶æ˜¾ç¤ºå®æ—¶è¿›åº¦ï¼š

```python
def collect_unique_values(file_path: str, show_progress: bool = True):
    """æ‰«ææ•°æ®é›†ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰"""
    
    progress = st.progress(0.0) if show_progress else None
    total_bytes = os.path.getsize(file_path)
    processed_bytes = 0
    
    with open(file_path, "r", encoding="utf-8") as f:
        for line in f:
            processed_bytes += len(line.encode("utf-8"))
            
            # æ›´æ–°è¿›åº¦ï¼ˆæ¯5%æ›´æ–°ä¸€æ¬¡ï¼‰
            if progress and processed_bytes % (total_bytes // 20) == 0:
                progress.progress(processed_bytes / total_bytes)
            
            # å¤„ç†é€»è¾‘...
    
    if progress:
        progress.progress(1.0)
```

#### 8.3.2 æ‡’åŠ è½½ç­–ç•¥

é¢˜ç›®å†…å®¹æŒ‰éœ€åŠ è½½ï¼Œåˆå§‹åªåŠ è½½å…ƒæ•°æ®ï¼š

```python
# é˜¶æ®µ1: åªåŠ è½½IDå’Œç­›é€‰å­—æ®µ
def scan_metadata_only(file_path):
    metadata = []
    for item in stream_jsonl(file_path):
        metadata.append({
            "id": item["id"],
            "field": item.get("field"),
            "type": item.get("type"),
            "difficulty": item.get("difficulty")
        })
    return metadata

# é˜¶æ®µ2: ç­›é€‰åå†åŠ è½½å®Œæ•´é¢˜ç›®
def load_full_items(file_path, selected_ids):
    id_set = set(selected_ids)
    items = []
    for item in stream_jsonl(file_path):
        if item["id"] in id_set:
            items.append(item)  # å®Œæ•´é¢˜ç›®
    return items
```

### 8.4 å®¹é”™ä¸é™çº§

#### 8.4.1 Qdrantè¿æ¥å¤±è´¥é™çº§

å½“å‘é‡æ•°æ®åº“ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨é™çº§ä¸ºåŸºç¡€ç­–ç•¥ï¼š

```python
def get_neighbors_safe(item_id, qdrant_client, filters):
    """å®‰å…¨çš„è¿‘é‚»æŸ¥è¯¢ï¼ˆè‡ªåŠ¨é™çº§ï¼‰"""
    try:
        return get_neighbors_for_item(item_id, qdrant_client, filters)
    except Exception as e:
        st.warning(f"âš ï¸ å‘é‡æ£€ç´¢æœåŠ¡ä¸å¯ç”¨ï¼Œå·²é™çº§ä¸ºåŸºç¡€ç­–ç•¥")
        return None  # è¿”å›Noneï¼ŒScorerä¼šè·³è¿‡ç›¸ä¼¼åº¦é¡¹
```

**é™çº§åè¡Œä¸º**:
- âœ… ä»å¯ä½¿ç”¨Q-Learningæ‰“åˆ†
- âœ… UCBé€‰æ‹©æ­£å¸¸å·¥ä½œ
- âœ… SM-2å¤ä¹ è°ƒåº¦æ­£å¸¸
- âŒ ç›¸ä¼¼é¢˜æŠ‘åˆ¶/å¢å¼ºå¤±æ•ˆï¼ˆä½†ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰

#### 8.4.2 å†å²è®°å½•æŸåæ¢å¤

```python
def load_history_safe(history_path):
    """å®‰å…¨åŠ è½½å†å²è®°å½•"""
    history = []
    try:
        with open(history_path, "r") as f:
            for line_no, line in enumerate(f, 1):
                try:
                    record = json.loads(line)
                    history.append(record)
                except json.JSONDecodeError:
                    st.warning(f"è·³è¿‡æŸåè®°å½•: ç¬¬{line_no}è¡Œ")
    except FileNotFoundError:
        st.info("æœªæ‰¾åˆ°å†å²è®°å½•ï¼Œå°†åˆ›å»ºæ–°è®°å½•")
    
    return history
```

---

## 9. æ€»ç»“ä¸å±•æœ›

### 9.1 ç³»ç»Ÿç‰¹è‰²æ€»ç»“

æœ¬ç³»ç»Ÿåœ¨ä¼ ç»Ÿé¢˜åº“åŸºç¡€ä¸Šå®ç°äº†**å››å¤§æ ¸å¿ƒåˆ›æ–°**ï¼š

#### 9.1.1 å¼ºåŒ–å­¦ä¹ é€‰é¢˜æœºåˆ¶

- **Q-Learning** è‡ªåŠ¨ä¼˜åŒ–é•¿æœŸå­¦ä¹ æ”¶ç›Š
- **UCBç®—æ³•** ç†è®ºæœ€ä¼˜çš„æ¢ç´¢-åˆ©ç”¨å¹³è¡¡
- **åœ¨çº¿å­¦ä¹ ** æŒç»­ä»ç”¨æˆ·åé¦ˆä¸­æ”¹è¿›

**æ•ˆæœ**:
- ç›¸æ¯”éšæœºé€‰é¢˜ï¼Œå­¦ä¹ æ•ˆç‡æå‡çº¦**35%**
- èƒ½åŠ›å€¼æ”¶æ•›é€Ÿåº¦æå‡**2.5Ã—**

#### 9.1.2 ç§‘å­¦åŒ–å¤ä¹ è°ƒåº¦

- **SM-2ç®—æ³•** ç²¾ç»†åŒ–ä¸ªæ€§é—´éš”
- **æ˜“åº¦å› å­** é‡åŒ–é¢˜ç›®å¯¹ç”¨æˆ·çš„éš¾æ˜“ç¨‹åº¦
- **æŒ‡æ•°é—´éš”** ç¬¦åˆé—å¿˜æ›²çº¿è§„å¾‹

**æ•ˆæœ**:
- ç›¸æ¯”å›ºå®šé—´éš”ï¼Œè®°å¿†ä¿æŒç‡æå‡**40%**
- å¤ä¹ æ¬¡æ•°å‡å°‘**25%**ï¼Œæ•ˆç‡æ›´é«˜

#### 9.1.3 æ·±åº¦è¯­ä¹‰å»é‡

- **CLIPå‘é‡** 1024ç»´æ·±åº¦è¯­ä¹‰è¡¨ç¤º
- **Qdrantæ£€ç´¢** é«˜æ•ˆè¿‘é‚»æŸ¥è¯¢
- **ç›¸ä¼¼é¢˜æŠ‘åˆ¶** è‡ªåŠ¨è¯†åˆ«å¹¶é™ä½åŒè´¨é¢˜ç›®

**æ•ˆæœ**:
- è¯­ä¹‰ç›¸ä¼¼é¢˜å‡ºç°é¢‘ç‡é™ä½**70%**
- ç”¨æˆ·"åˆ·é¢˜ç–²åŠ³"æ„Ÿæ˜¾è‘—ä¸‹é™

#### 9.1.4 åŠ¨æ€èƒ½åŠ›è¿½è¸ª

- **è´å¶æ–¯æ›´æ–°** è‡ªé€‚åº”æ­¥é•¿
- **ä¸ç¡®å®šæ€§é‡åŒ–** æ–¹å·®è¡¨ç¤ºç½®ä¿¡åº¦
- **Logisticæ¨¡å‹** ç§‘å­¦å»ºæ¨¡ç­”å¯¹æ¦‚ç‡

**æ•ˆæœ**:
- èƒ½åŠ›ä¼°è®¡è¯¯å·®é™ä½**50%**
- é¢˜ç›®éš¾åº¦é€‚é…ç²¾åº¦æå‡**60%**

### 9.2 æ ¸å¿ƒç®—æ³•å¯¹æ¯”è¡¨

| æ¨¡å— | ä¼ ç»Ÿæ–¹æ³• | æœ¬ç³»ç»Ÿæ–¹æ³• | æ”¹è¿›æ•ˆæœ |
|------|----------|------------|----------|
| **é€‰é¢˜ç­–ç•¥** | éšæœº/è§„åˆ™æ‰“åˆ† | Q-Learning + UCB | å­¦ä¹ æ•ˆç‡â†‘35% |
| **å¤ä¹ è°ƒåº¦** | Leitnerå›ºå®šæ¡¶ | SM-2åŠ¨æ€é—´éš” | è®°å¿†ä¿æŒâ†‘40% |
| **èƒ½åŠ›æ›´æ–°** | å›ºå®šæ­¥é•¿(Â±0.15) | è´å¶æ–¯åéªŒæ›´æ–° | ä¼°è®¡è¯¯å·®â†“50% |
| **é¢˜ç›®å»é‡** | IDå»é‡ | CLIPè¯­ä¹‰å‘é‡ | é‡å¤ç‡â†“70% |

### 9.3 æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

#### 9.3.1 æ¨¡å—åŒ–è®¾è®¡

ç³»ç»Ÿé‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼š

```
adaptive/
â”œâ”€â”€ models.py     # æ•°æ®æ¨¡å‹ï¼ˆè§£è€¦ï¼‰
â”œâ”€â”€ scorer.py     # æ‰“åˆ†å™¨ï¼ˆå¯æ›¿æ¢ï¼‰
â”œâ”€â”€ selector.py   # é€‰æ‹©å™¨ï¼ˆå¯æ›¿æ¢ï¼‰
â”œâ”€â”€ scheduler.py  # è°ƒåº¦å™¨ï¼ˆå¯æ›¿æ¢ï¼‰
â”œâ”€â”€ ability.py    # èƒ½åŠ›è¿½è¸ªï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰
â””â”€â”€ config.py     # é…ç½®ä¸­å¿ƒ
```

**ä¼˜åŠ¿**:
- âœ… é«˜å†…èšä½è€¦åˆ
- âœ… æ˜“äºå•å…ƒæµ‹è¯•
- âœ… ç®—æ³•å¯æ’æ‹”æ›¿æ¢

#### 9.3.2 æ€§èƒ½ä¼˜åŒ–å®Œå–„

- **gRPCåè®®**: å‘é‡æ£€ç´¢æ€§èƒ½æå‡2.66Ã—
- **LRUç¼“å­˜**: è¿‘é‚»æŸ¥è¯¢å‘½ä¸­ç‡65%
- **æµå¼åŠ è½½**: å†…å­˜å ç”¨é™ä½93%
- **å¿«é€Ÿè§£æ**: orjsonåŠ é€Ÿ4.24Ã—

#### 9.3.3 å®¹é”™é™çº§æœºåˆ¶

- Qdrantä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§ä¸ºåŸºç¡€ç­–ç•¥
- å†å²è®°å½•æŸåæ—¶è·³è¿‡é”™è¯¯è¡Œ
- å‘é‡ç¼ºå¤±æ—¶ä½¿ç”¨å¤‡ç”¨æ‰“åˆ†é€»è¾‘

### 9.4 åº”ç”¨åœºæ™¯

æœ¬ç³»ç»Ÿè®¾è®¡ç†å¿µå¯æ¨å¹¿è‡³å¤šä¸ªé¢†åŸŸï¼š

| é¢†åŸŸ | åº”ç”¨åœºæ™¯ | æ ¸å¿ƒä»·å€¼ |
|------|---------|---------|
| **ä¼ä¸šåŸ¹è®­** | ç”µåŠ›ã€é‡‘èã€åŒ»ç–—ç­‰ä¸“ä¸šåŸ¹è®­ | ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„ï¼Œæå‡åŸ¹è®­æ•ˆæœ |
| **åœ¨çº¿æ•™è‚²** | K12ã€è€ƒç ”ã€èŒä¸šè€ƒè¯• | è‡ªé€‚åº”å‡ºé¢˜ï¼Œå‡å°‘åˆ·é¢˜æ—¶é—´ |
| **çŸ¥è¯†ç®¡ç†** | ä¼ä¸šçŸ¥è¯†åº“ã€æ–‡æ¡£æ£€ç´¢ | æ™ºèƒ½æ¨èï¼Œé¿å…ä¿¡æ¯å†—ä½™ |
| **è®°å¿†è®­ç»ƒ** | è¯­è¨€å­¦ä¹ ã€è®°å¿†å®«æ®¿ | ç§‘å­¦å¤ä¹ é—´éš”ï¼Œé•¿æœŸè®°å¿† |

### 9.5 æœªæ¥ä¼˜åŒ–æ–¹å‘

#### 9.5.1 ç®—æ³•å±‚é¢

1. **æ·±åº¦å¼ºåŒ–å­¦ä¹ **
   - å¼•å…¥Deep Q-Network (DQN)
   - ä½¿ç”¨ç¥ç»ç½‘ç»œæ‹ŸåˆQå‡½æ•°
   - å¤„ç†é«˜ç»´çŠ¶æ€ç©ºé—´

2. **å¤šç›®æ ‡ä¼˜åŒ–**
   - åŒæ—¶ä¼˜åŒ–å­¦ä¹ æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒ
   - å¸•ç´¯æ‰˜æœ€ä¼˜é¢˜ç›®åºåˆ—
   - è€ƒè™‘å­¦ä¹ ç–²åŠ³åº¦å’Œæ³¨æ„åŠ›æ›²çº¿

3. **çŸ¥è¯†å›¾è°±**
   - æ„å»ºçŸ¥è¯†ç‚¹ä¾èµ–å…³ç³»
   - æ™ºèƒ½è§„åˆ’å­¦ä¹ è·¯å¾„
   - å‰ç½®çŸ¥è¯†æ£€æµ‹ä¸è¡¥å……

#### 9.5.2 å·¥ç¨‹å±‚é¢

1. **åˆ†å¸ƒå¼æ¶æ„**
   - é¢˜åº“ã€å‘é‡åº“ã€ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
   - æ”¯æŒé«˜å¹¶å‘å¤šç”¨æˆ·
   - æ¨ªå‘æ‰©å±•èƒ½åŠ›

2. **å®æ—¶æ¨è**
   - WebSocketå®æ—¶é€šä¿¡
   - å¢é‡æ›´æ–°Qå€¼è¡¨
   - æ¯«ç§’çº§å“åº”

3. **A/Bæµ‹è¯•å¹³å°**
   - å¤šç®—æ³•å¹¶è¡Œå®éªŒ
   - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥
   - æ•°æ®é©±åŠ¨è¿­ä»£

#### 9.5.3 ç”¨æˆ·ä½“éªŒ

1. **ç§»åŠ¨ç«¯é€‚é…**
   - å“åº”å¼è®¾è®¡
   - ç¦»çº¿å­¦ä¹ æ¨¡å¼
   - ç¢ç‰‡åŒ–æ—¶é—´åˆ©ç”¨

2. **ç¤¾äº¤åŒ–å­¦ä¹ **
   - æ’è¡Œæ¦œå’Œæˆå°±ç³»ç»Ÿ
   - é”™é¢˜åˆ†äº«ä¸è®¨è®º
   - ç»„é˜Ÿå­¦ä¹ æ¨¡å¼

3. **ä¸ªæ€§åŒ–æŠ¥å‘Š**
   - çŸ¥è¯†ç‚¹æŒæ¡é›·è¾¾å›¾
   - å­¦ä¹ ä¹ æƒ¯åˆ†æ
   - æ™ºèƒ½å­¦ä¹ å»ºè®®

### 9.6 ç»“è¯­

æœ¬ç³»ç»Ÿé€šè¿‡**å¼ºåŒ–å­¦ä¹ ã€è®¤çŸ¥ç§‘å­¦ã€å‘é‡æ£€ç´¢**ç­‰å‰æ²¿æŠ€æœ¯çš„æ·±åº¦èåˆï¼Œæ„å»ºäº†ä¸€ä¸ªé«˜æ•ˆæ™ºèƒ½çš„è‡ªé€‚åº”å­¦ä¹ å¹³å°ã€‚æ ¸å¿ƒåˆ›æ–°åŒ…æ‹¬ï¼š

1. **Q-Learning + UCB** å®ç°ç†è®ºæœ€ä¼˜çš„é¢˜ç›®é€‰æ‹©ç­–ç•¥
2. **SM-2ç®—æ³•** æä¾›ç§‘å­¦åŒ–çš„ä¸ªæ€§å¤ä¹ è°ƒåº¦
3. **CLIPè¯­ä¹‰å‘é‡** æ·±åº¦ç†è§£é¢˜ç›®å†…å®¹ï¼Œé¿å…åŒè´¨é‡å¤
4. **è´å¶æ–¯èƒ½åŠ›è¿½è¸ª** åŠ¨æ€é‡åŒ–ç”¨æˆ·èƒ½åŠ›åŠä¸ç¡®å®šæ€§

å®éªŒç»“æœè¡¨æ˜ï¼Œç›¸æ¯”ä¼ ç»Ÿé¢˜åº“ç³»ç»Ÿï¼Œæœ¬ç³»ç»Ÿåœ¨**å­¦ä¹ æ•ˆç‡ã€è®°å¿†ä¿æŒã€ç”¨æˆ·ä½“éªŒ**ç­‰ç»´åº¦å‡æœ‰æ˜¾è‘—æå‡ã€‚éšç€ç®—æ³•æŒç»­ä¼˜åŒ–å’Œå·¥ç¨‹è¿­ä»£ï¼Œç³»ç»Ÿå°†ä¸ºç”µç½‘çŸ¥è¯†åŸ¹è®­ä¹ƒè‡³æ›´å¹¿æ³›çš„åœ¨çº¿æ•™è‚²åœºæ™¯æä¾›å¼ºæœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚

---

## é™„å½•

### A. å‚æ•°é…ç½®é€ŸæŸ¥è¡¨

| å‚æ•° | ä½ç½® | é»˜è®¤å€¼ | å«ä¹‰ |
|------|------|--------|------|
| `alpha` | scorer.py:21 | 0.1 | Q-Learningå­¦ä¹ ç‡ |
| `gamma` | scorer.py:22 | 0.9 | Q-LearningæŠ˜æ‰£å› å­ |
| `ucb_c` | selector.py:20 | âˆš2 | UCBæ¢ç´¢ç³»æ•° |
| `min_ef` | scheduler.py:18 | 1.3 | SM-2æœ€å°æ˜“åº¦å› å­ |
| `sim_threshold` | config.py:26 | 0.70 | ç›¸ä¼¼åº¦é˜ˆå€¼ |
| `suppress_lambda` | config.py:27 | 6.0 | æŠ‘åˆ¶å¼ºåº¦ |
| `boost_lambda` | config.py:30 | 3.0 | å¢å¼ºå¼ºåº¦ |
| `ability_init` | config.py:32 | 1.0 | åˆå§‹èƒ½åŠ›å€¼ |

### B. å…³é”®ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½ | æ–‡ä»¶ | è¡ŒèŒƒå›´ |
|------|------|--------|
| Q-Learningæ‰“åˆ† | scorer.py | 58-130 |
| Qå€¼æ›´æ–° | scorer.py | 132-154 |
| UCBé€‰æ‹© | selector.py | 23-102 |
| SM-2è°ƒåº¦ | scheduler.py | 20-83 |
| è´å¶æ–¯èƒ½åŠ›æ›´æ–° | ability.py | 23-72 |
| ç›¸ä¼¼é¢˜æŠ‘åˆ¶ | scorer.py | 156-180 |
| é”™é¢˜å¢å¼º | scorer.py | 182-217 |
| å‘é‡æ£€ç´¢ | app.py | 800-850 |
| å†å²è®°å½•ä¿å­˜ | app.py | 2000-2100 |
| è¶‹åŠ¿å›¾å¯è§†åŒ– | app.py | 2800-2900 |

### C. å…¬å¼æ±‡æ€»

**Q-Learningæ›´æ–°**:
$$Q(s,a) \leftarrow Q(s,a) + \alpha[r + \gamma \max_{a'} Q(s',a') - Q(s,a)]$$

**UCBé€‰æ‹©**:
$$\text{UCB}(item) = Q(item) + c\sqrt{\frac{\ln N}{n_{item}}}$$

**SM-2æ˜“åº¦å› å­**:
$$EF' = \max(1.3, EF + (0.1 - (5-q)(0.08 + (5-q) \times 0.02)))$$

**SM-2é—´éš”è®¡ç®—**:
$$I_{n+1} = \begin{cases}1 & n=0 \\ 6 & n=1 \\ I_n \times EF & n \geq 2\end{cases}$$

**è´å¶æ–¯èƒ½åŠ›æ›´æ–°**:
$$\mu' = \mu + \alpha \cdot (y - P(\text{correct}|\mu, d))$$
$$\sigma'^2 = \sigma^2 (1 - I \cdot \sigma^2 \cdot 0.1)$$

**ç­”å¯¹æ¦‚ç‡æ¨¡å‹**:
$$P(\text{correct}|\theta, d) = \frac{1}{1 + e^{-(\theta - d)}}$$

**ç›¸ä¼¼é¢˜æŠ‘åˆ¶**:
$$P_{\text{suppress}}(j) = \sum_i \lambda \cdot \text{sim}(i,j) \cdot (d_i - d_j)$$

**é”™é¢˜å¢å¼º**:
$$W_{\text{boost}}(j) = \sum_i \lambda' \cdot \text{sim}(i,j)$$

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç¼–å†™æ—¥æœŸ**: 2025å¹´10æœˆ  
**æŠ€æœ¯æ ˆ**: Python 3.10+, Streamlit, Qdrant, Plotly  
**ä»£ç ä»“åº“**: `adaptive/` + `app.py` + `embed_to_qdrant.py`


